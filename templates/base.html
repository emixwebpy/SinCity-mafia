<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="/static/icon-media/Untitled.jpg" />
  <title>{% block title %}Underworld Tycoon{% endblock %}</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <style>
      html, body {
        font-family: "Fira Sans", sans-serif;
        font-size:0.85em;
        background-color: #181818;
        color: #f8f8ff;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        width: 100vw;
        font-size: 12px;
        letter-spacing: 0.01em;
        transition: background 0.3s;
      }
      .fade-in {background:#18182400; animation: fadeIn 0.7s cubic-bezier(.4,2,.6,1) forwards; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      .graveyard-bgbb {
          background: url('https://images.unsplash.com/photo-1549861833-c5932fd19229?q=80&w=1333&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
          background-size: cover;
          background-position: center;
          position: fixed;
          top: 0; left: 0; width: 100vw; height: 100vh;
          z-index: -2;
          filter: grayscale(0.25) brightness(0.5) blur(1px);
      }
      .graveyard-overlay {
          position: fixed;
          top: 0; left: 0; width: 100vw; height: 100vh;
          background: linear-gradient(180deg, rgba(24,24,36,0.92) 60%, rgba(35,36,58,0.98) 100%);
          z-index: -1;
          overflow:auto;
      }
      /* Layout */
      .layout-root {
        display: flex;
        min-height: 50vh;
        width: 100vw;
        background: none;
        overflow-x: hidden;
      }

      /* Sidebar */
      /* Sidebar - Modern Sleek Restyle */
      .sidebar {
        width: 170px;
        background: linear-gradient(120deg, #181824 60%, #23243a 100%);
        display: flex;
        flex-direction: column;
        align-items: stretch;
        z-index: 300;
        transition: width 0.22s cubic-bezier(.4,2,.6,1), background 0.22s;
        border-right: none;
        height: 100vh;
        position: sticky;
        top: 0;
        font-size: 13px;
        padding: 0;
        
        border-right: 1px solid #ffd70033;
        overflow: hidden;
      }
      .sidebar-header {
        color: #ffd700;
        
        font-weight: 900;
        padding: 0 0 20px 0;
        text-align: center;
        letter-spacing: 2px;
        text-shadow: 0 2px 16px #23243a;
        background: linear-gradient(120deg, #181824 60%, #23243a 100%);
        border-bottom: 1.5px solid #ffd70022;
      }
      .sidebar-user {
        color: #f8f8ff;
        text-align: center;
        font-size: 2em;
        font-weight: 700;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-bottom: 12px;
        background: #181824;
        border-bottom: 1px solid #23243a;
        padding-top: 15px;
        
        
        
      }
      .sidebar-user i {
        
        margin-bottom: 4px;
        color: #ffd700;
        filter: drop-shadow(0 2px 8px #23243a);
      }
      .sidebar-nav {
        width: 100%;
        flex: 1 1 0;
        
        flex-direction: column;
        gap: 12px;
        padding: 0 0 18px 0;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #ffd70033 #23243a;
      }
      .sidebar-category {
        margin-bottom: 0;
        overflow-y: visible;
        scrollbar-width: thin;
        scrollbar-color: #ffd70033 #23243a;
        
        
        
        transition: background 0.18s, box-shadow 0.18s;
        
        display: flex;
        flex-direction: column;
      }
      .sidebar-category-title {
        color: #ffd700;
        font-size: 0.8em;
        font-weight: 700;
        padding: 15px 26px 10px 26px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        opacity: 0.97;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-content: stretch;
        justify-content: space-between;
        
        transition: background 0.18s, color 0.18s;
       
        
      }
      .sidebar-category-title:hover {
        background: linear-gradient(90deg, #ffd70033 0%, #23243a 100%);
        color: #8be9fd;
      }
      .collapse-arrow {
        margin-left: 8px;
        transition: transform 0.2s;
        color: #8be9fd;
      }
      .sidebar-category.collapsed .collapse-arrow {
        transform: rotate(-90deg);
      }
      .sidebar-subnav {
        width: 100%;
        margin-left: 0;
        border-left: none;
        
        display: flex;
        flex-direction: column;
        
        transition: max-height 0.2s, opacity 0.2s;
        overflow: hidden;
        max-height: 500px;
        opacity: 1;
        background: none;
        
      }
      .sidebar-category.collapsed .sidebar-subnav {
        max-height: 0;
        opacity: 0;
        pointer-events: none;
      }
      .sidebar-nav a {
        color: #b8b8ff;
        font-size: 0.8em;
        font-weight: 500;
        padding: 13px 18px;
        width: 100%;
        display: flex;
        align-items: center;
        gap: 14px;
        text-decoration: none;
        transition: background 0.18s, color 0.18s , padding-left 0.18s, box-shadow 0.18s;
        position: relative;
        letter-spacing: 0.2px;
        white-space: nowrap;
        background: none;
        
        margin: 2px 8px;
      }
      .sidebar-nav a.active{
        background: #8be9fd;
        color: #23243a;
        width: 100%;
        
        
        
      }
      .sidebar-nav a:hover {
        background: #ffd700;
        color: #23243a;
        width: 100%;
        padding-left: 24px;
        
        
      }
      .sidebar-footer {
        padding: 12px 16px 16px 16px;
        border-top: 1px solid #23243a;
        
        margin-top: 10px;
        
        
      }
      .sidebar-footer .btn {
        width: 100%;
        text-align: center;
        font-weight: 700;
        background: #ffd700;
        color: #23243a;
        border: none;
        transition: background 0.18s, color 0.18s;
        
        letter-spacing: 0.5px;
        font-size: 15px;
        
        margin-top: 6px;
      }
      .sidebar-footer .btn:hover {
        background: #8be9fd;
        color: #23243a;
        transition: background 0.18s, color 0.18s, box-shadow 0.18s;
        box-shadow: 0 2px 8px #8be9fd55;
      }

      /* Topbar */
      .topbar {
        
        width: 100vw;
        min-width: 103vw;
        max-width: 100vw;
        height: auto;
        background: linear-gradient(135deg, #181824 0%, #23243a 100%);
        display: flex;
        align-items: center;
        padding: 0 44px;
        box-sizing: border-box;
        z-index: 10;
        position: sticky;
        left: 0;
        top: 0;
        border-bottom: 2px solid #ffd70033;
        font-size: 12px;
        color: #f8f8ff;
        transition: background 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 16px #23243a33;
        overflow-x: hidden;
      }
      .topbar-title {
        
        font-size: 2.1em;
        font-weight: 900;
        letter-spacing: 1.5px;
        text-shadow: 0 2px 12px #23243a;
        flex: 1;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .topbar-title i {
        
        color: #8be9fd;
        text-shadow: 0 2px 8px #8be9fd55;
      }
      .topbar-title a {
        color: #ffd700;
        text-decoration: none;
        transition: color 0.18s;
      }
      .topbar-title a:hover {
        color: #ff5555;
        text-decoration: none;
        
      }
      .topbar-actions {
        margin-left: 24px;
        display: flex;
        align-items: center;
        gap: 65px;
        justify-content: flex-start;
      }
      .topbar-actions .btn {
        font-weight: 700;
        background: #ffd700;
        color: #23243a;
        border: none;
        padding: 11px 24px;
        transition: background 0.18s, color 0.18s, box-shadow 0.18s;
        box-shadow: 0 2px 8px #ffd70033;
        letter-spacing: 0.5px;
        font-size: 1.05em;
        white-space: nowrap;
        min-width: 0;
        max-width: 100vw;
        width: auto;
        margin: 5px;
        
      }
      .topbar-actions .btn:hover {
        background: #8be9fd;
        color: #23243a;
        box-shadow: 0 4px 12px #8be9fd55;
      }
      .topbar-actions .badge {
        background: linear-gradient(90deg, #23243a 0%, #ffd700 100%);
        color: #23243a;
        padding: 7px 16px;
        font-size: 1.05em;
        font-weight: 700;
        box-shadow: 0 2px 8px #2d2f4b;
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        min-width: 0;
        max-width: 100vw;
        width: auto;
        margin-bottom: 0;
        margin-right: 0;
      }
      @media (max-width: 900px) {
        .topbar-actions .btn,
        .topbar-actions .badge {
          font-size: 1em !important;
          padding: 9px 10px !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          width: 100%;
          min-width: 0;
          max-width: 100vw;
          box-sizing: border-box;
          justify-content: center;
        }
        .topbar-actions {
          gap: 6px !important;
          margin-left: 0 !important;
        }
      }
      .topbar-actions .badge i {
        color: #ffd700;
        font-size: 1.2em;
      }

      /* Main Area */
      .main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        width: 100vw;
        max-width: 100%;
        margin: 0 auto;
        min-height: 100vh;
        max-height: 100vh;
        color: #f8f8ff;
        font-size: 12px;
        box-sizing: border-box;
        scrollbar-width: thin;
        scrollbar-color: #ffd700 #23243a;
      }

      /* Content */
      .content-area {
        flex: 1 1 auto;
        padding: 18px 18px 24px 24px;
        min-width: 0;
        
        background: none;
        font-size: 1.07em;
      }
      .flashes {
        list-style: none;
        padding: 0;
        margin-bottom: 22px;
      }
      .flashes li {
        background: #23243a;
        color: #ffd700;
        padding: 12px 0;
        border-radius: 7px;
        margin-bottom: 10px;
        font-weight: 700;
        text-align: center;
        box-shadow: 0 1px 8px #ffd70022;
      }
      footer {
        text-align: center;
        color: #8be9fd;
        font-size: 1.05em;
        padding: 22px 0 10px 0;
        opacity: 0.7;
        letter-spacing: 0.5px;
      }

      /* Floating Chat */
      #floating-chat {
        position: fixed;
        bottom: 32px;
        right: 32px;
        width: 340px;
        height: 370px;
        background: rgba(25, 25, 40, 0.98);
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        z-index: 9999;
        border: 2px solid #ffd70055;
        overflow: hidden;
        font-size: 1em;
        transition: box-shadow 0.18s, width 0.18s, height 0.18s;
        min-width: 300px;
        min-height: 180px;
        max-width: 98vw;
        max-height: 60vh;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px #ffd70033, 0 1.5px 0 #ffd70022 inset;
        resize: both ;
        direction: rtl;
      }
      #floating-chat > * {
        direction: ltr;
      }
      .chat-header {
        background: linear-gradient(90deg, #ffd700 0%, #23243a 95%);
        color: #23243a;
        font-weight: 700;
        padding: 12px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1.5px solid #ffd70044;
        font-size: 1.12em;
        letter-spacing: 0.5px;
      }
      .chat-header .chat-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.13em;
      }
      .chat-header .chat-close {
        background: none;
        border: none;
        color: #ffd700;
        font-size: 1.3em;
        cursor: pointer;
        transition: color 0.18s;
        padding: 0 6px;
      }
      .chat-header .chat-close:hover {
        color: #ff5555;
      }
      .chat-tabs {
        display: flex;
        background: #23243a;
        border-bottom: 1.5px solid #ffd70044;
      }
      .chat-tab {
        flex: 1;
        padding: 10px 0;
        background: none;
        color: #ffd700;
        border: none;
        font-weight: 700;
        font-size: 1em;
        cursor: pointer;
        transition: background 0.18s, color 0.18s;
        border-bottom: 2px solid transparent;
        outline: none;
        border-radius: 0;
      }
      .chat-tab.active-tab {
        background: #181824;
        color: #8be9fd;
        border-bottom: 2px solid #8be9fd;
      }
      .chat-tab:not(.active-tab):hover {
        background: #2d2e4a;
        color: #fff;
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 14px 16px 10px 16px;
        background: #23243a;
        color: #f8f8ff;
        font-size: 1em;
        display: flex;
        flex-direction: column;
        gap: 7px;
        scrollbar-width: thin;
        scrollbar-color: #ffd700 #23243a;
      }
      .chat-message {
        background: rgba(255,215,0,0.10);
        border-radius: 7px;
        padding: 7px 12px;
        color: #fff;
        font-size: 1em;
        word-break: break-word;
        box-shadow: 0 1px 4px #ffd70022;
        margin-bottom: 2px;
        align-self: flex-start;
        max-width: 90%;
      }
      .chat-message.me {
        background: #8be9fd33;
        color: #ffd700;
        align-self: flex-end;
      }
      .chat-message .chat-username {
        font-weight: 700;
        color: #8be9fd;
        margin-right: 8px;
      }
      .chat-message .chat-time {
        font-size: 0.85em;
        color: #b8b8ff;
        margin-left: 10px;
      }
      #chat-form {
        display: flex;
        border-top: 1.5px solid #ffd70044;
        background: #181824;
        padding: 10px 12px;
        gap: 8px;
      }
      #chat-input {
        flex: 1;
        border: none;
        padding: 9px 12px;
        font-size: 1em;
        background: #23243a;
        color: #f8f8ff;
        border-radius: 7px;
        outline: none;
        transition: box-shadow 0.18s;
      }
      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 900px;
        margin: 0 auto 24px auto;
        padding: 24px 32px;
        background: #23243a;
        border-radius: 14px;
        box-shadow: 0 2px 12px #23243a55;
        color: #f8f8ff;
      }
      .markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
        color: #ffd700;
        margin-top: 1.5em;
        margin-bottom: 0.5em;
      }
      .markdown-body a { color: #8be9fd; }
      .markdown-body code, .markdown-body pre {
        background: #181824;
        color: #ffd700;
        border-radius: 6px;
        padding: 2px 6px;
      }
      .markdown-body pre {
        padding: 12px;
        overflow-x: auto;
      }
      .markdown-body blockquote {
        border-left: 4px solid #ffd700;
        background: #181824;
        color: #ffd700;
        padding: 8px 18px;
        border-radius: 8px;
      }
      .markdown-body table {
        background: #181824;
        color: #f8f8ff;
        border-radius: 8px;
        margin-bottom: 1em;
      }
      .markdown-body th, .markdown-body td {
        border: 1px solid #ffd70033;
        padding: 8px 12px;
      }
      .markdown-body ul, .markdown-body ol {
        margin-left: 2em;
      }
      .markdown-body hr {
        border: none;
        border-top: 2px solid #ffd70033;
        margin: 2em 0;
      }
      #chat-input:focus {
        box-shadow: 0 0 0 2px #ffd70055;
      }
      #chat-submit {
        background: #ffd700;
        color: #23243a;
        border: none;
        border-radius: 7px;
        padding: 9px 22px;
        font-weight: 700;
        font-size: 1em;
        cursor: pointer;
        transition: background 0.18s, color 0.18s;
      }
      #chat-submit:hover {
        background: #8be9fd;
        color: #23243a;
      }
      .toggle-chat {
        position: fixed;
        bottom: 15px;
        right: 32px;
        z-index: 150; /* Lower than sidebar (z-index: 200/300) so it goes behind */
        background: #ffd700;
        color: #23243a;
        border: none;
        border-radius: 50%;
        width: 54px;
        height: 54px;
        font-size: 1.7em;
        box-shadow: 0 2px 12px #ffd70044;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.18s, color 0.18s, box-shadow 0.18s;
      }
      .toggle-chat:hover {
        background: #8be9fd;
        color: #23243a;
        box-shadow: 0 4px 16px #8be9fd55;
      }
      /* --- Profile styles from profile.html for card look --- */
      .online-card-container {
          display: flex;
          justify-content: center;
          align-items: stretch;
          gap: 36px;
          margin-top: 15px;
          flex-wrap: wrap;
      }
      .online-card {
          background: linear-gradient(120deg, #181824 60%, #23243a 100%);
          border-radius: 18px;
          box-shadow: 0 6px 32px #00000044;
          display: flex;
          flex-direction: column;
          overflow: hidden;
          min-width: 340px;
          max-width: 900px;
          width: 100%;
          margin-bottom: 32px;
      }
      .online-card-header {
          display: flex;
          align-items: center;
          gap: 18px;
          margin-bottom: 12px;
          justify-content: center;
      }
      .online-card-header h1 {
          color: #ffd700;
          font-size: 2.2rem;
          margin: 0;
          letter-spacing: 2px;
      }
      .online-card-list {
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
          align-items: center;
          justify-content: center;
          padding-bottom: 10px;
      }
      .online-badge {
          background: #23243a;
          color: #8be9fd;
          font-weight: 600;
          border-radius: 8px;
          padding: 7px 16px;
          margin-bottom: 4px;
          text-decoration: none;
          box-shadow: 0 1px 4px #8be9fd22;
          transition: background 0.18s, color 0.18s;
          display: inline-block;
      }
      .online-badge.current-user {
          background: #ffd70022;
          color: #ffd700;
          font-weight: 700;
          box-shadow: 0 1px 4px #ffd70022;
      }
      
      .btn-primary {
          background: linear-gradient(90deg, #ffb347 0%, #ffd700 100%);
          color: #232526;
          border: none;
          padding: 0.7rem 1.5rem;
          border-radius: 6px;
          font-weight: bold;
          margin-bottom: 0;
          transition: background 0.2s;
          text-decoration: none;
          cursor: pointer;
          display: inline-flex;
          align-items: center;
          gap: 8px;
          font-size: 1.08em;
          box-shadow: 0 2px 8px #ffd70033;
      }
      .btn-primary:hover {
          background: linear-gradient(90deg, #ffd700 0%, #ffb347 100%);
          color: #232526;
      }
      .btn-danger {
          background: #ff5555;
          color: #fff;
          border: none;
          padding: 0.7rem 1.5rem;
          border-radius: 6px;
          font-weight: bold;
          transition: background 0.2s;
          text-decoration: none;
          cursor: pointer;
      }
      .btn-danger:hover {
          background: #ff2222;
          color: #fff;
      }
      /* Responsive */
      /* --- Extra Mobile Responsive Tweaks --- */
      @media (max-width: 900px) {
        .main-area {
          margin-left: 0 !important;
          width: 100vw !important;
          max-width: 100vw !important;
        }
        #topbar-logout-btn {
            display: none !important;
          }
        #topbar-logout-btn {
            display: inline-block !important;
          }
        .topbar {
          left: 0 !important;
          width: 100vw !important;
          min-width: 0 !important;
          max-width: 100vw !important;
          padding: 0 10px !important;
        }
        .content-area {
          padding: 10px 2vw !important;
          margin-top: 60px !important;
        }
        footer {
          font-size: 0.95em;
          padding: 12px 0 8px 0;
        }
        .online-card {
          min-width: 0 !important;
          width: 98vw !important;
          max-width: 100vw !important;
          margin-bottom: 18px !important;
          border-radius: 10px !important;
          padding: 10px 6px !important;
        }
        .online-card-header h1 {
          font-size: 1.1rem !important;
        }
        .online-card-list, .online-card-header {
          gap: 8px !important;
        }
        .markdown-body {
          padding: 10px 4vw !important;
          font-size: 1em !important;
        }
      }
      @media (max-width: 600px) {
        .main-area, .content-area, .topbar {
          width: 100vw !important;
          max-width: 100vw !important;
          min-width: 0 !important;
        }
        .topbar {
          font-size: 1em !important;
          padding: 0 2vw !important;
        }
        .sidebar {
          width: 50vw !important;
        }
        .markdown-body {
          padding: 6px 2vw !important;
          font-size: 0.98em !important;
        }
        .online-card {
          padding: 6px 2vw !important;
        }
        .sidebar-toggle-btn {
          width: 38px !important;
          height: 38px !important;
          font-size: 1.1em !important;
        }
      }
      @media (max-width: 400px) {
        .topbar-title {
          font-size: 1.1em !important;
        }
        .sidebar-toggle-btn {
          width: 30px !important;
          height: 30px !important;
          font-size: 1em !important;
        }
        .markdown-body {
          font-size: 0.92em !important;
        }
      }
      @media (max-width: 900px) {
        html, body { font-size: 15px; }
        .layout-root { flex-direction: column; }
        .sidebar {
          width: 25vw;
          min-width: 0;
          height: 100vh;
          flex-direction: column;
          position: fixed;
          left: 0;
          top: 0;
          z-index: 200;
          border-right: none;
          
          padding: 0;
          
          transition: transform 0.3s cubic-bezier(.4,2,.6,1), width 0.22s, background 0.22s;
          transform: translateX(-100%);
        }
        .sidebar.open {
          transform: translateX(0);
        }
        .sidebar-nav {
          
          flex-direction: column;
          width: 100%;
          gap: 0;
          padding: 0 4px;
          overflow-x: auto;
          overflow-y: auto;
          max-height: 100vh;
        }
        .sidebar-category {
          min-width: 60px;
          flex: 1 1 0;
          margin-bottom: 0;
          border-radius: 0;
          display: flex;
          flex-direction: column;
        }
        .sidebar-category-title {
          font-size: 0.95em;
          padding: 8px 8px 6px 8px;
          border-radius: 0;
        }
        .sidebar-subnav {
          display: flex !important;
          flex-direction: column !important;
          padding-left: 4px;
          border-left: none;
          gap: 0;
          max-height: 500px;
          opacity: 1;
        }
        .sidebar-category.collapsed .sidebar-subnav {
          max-height: 0;
          opacity: 0;
          pointer-events: none;
        }
        .sidebar-subnav a {
          font-size: 0.95em;
          padding: 8px 8px;
          display: block;
          margin: 0;
          border-radius: 0;
        }
        .sidebar .sidebar-header,
        .sidebar .sidebar-user {
          display: none;
        }
        .sidebar-footer {
          display: none;
        }
        .content-area {
          padding: 10px 2vw;
          min-width: 0;
          width: 100vw;
        }
        #floating-chat, .toggle-chat {
          right: 1vw !important;
          bottom: 10px !important;
          width: 99vw !important;
          max-width: 98vw !important;
          min-width: 0 !important;
          font-size: 0.98em;
          border-radius: 8px;
        }
        .sidebar-toggle-btn {
          display: block;
        }
      }
      @media (max-width: 600px) {
        .sidebar {
          width: 95vw;
          max-height: 100vh;
          overflow-y: auto;
        }
      }
      .sidebar-toggle-btn {
        display: none;
        position: fixed;
        top: 47px;
        left: 18px;
        z-index: 300;
        background: #ffd700;
        color: #23243a;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        font-size: 1.5em;
        box-shadow: 0 2px 12px #ffd70044;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.18s, color 0.18s, box-shadow 0.18s;
      }
      .sidebar-toggle-btn:hover {
        background: #8be9fd;
        color: #23243a;
        box-shadow: 0 4px 16px #8be9fd55;
      }
      
  </style>

</head>

<body style="background: #181824; color: #f5f6fa;" class="fade-in">
  
  <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="Open sidebar" aria-label="Open sidebar" aria-controls="sidebar" aria-expanded="false" style="display:none;">
    <i class="fas fa-bars"></i>
  </button>
  <div class="layout-root fade-in" style="position:relative; z-index:1; min-height:100vh;">
    {% block sidebar %}
    {% set hide_sidebar = request.endpoint in ['login', 'register'] %}
    {% if not hide_sidebar %}
    <div class="sidebar" id="sidebar" style="z-index:300; position:fixed; left:0; top:0; height:100vh;">
      {% if current_user.is_authenticated %}
        <div class="sidebar-user">
          {% set character = current_character %}
          {% if character and character.profile_image %}
            <img
              src="{{ url_for('static', filename=character.profile_image) if not character.profile_image.startswith('http') else character.profile_image }}"
              class="crew-avatar"
              alt="avatar"
              style="width:48px;height:48px;border-radius:50%;margin-bottom:6px;border:2px solid #ffd700;object-fit:cover;"
            >
          {% else %}
            <i id="char-name" class="fas fa-user-circle"></i>
          {% endif %}
          {% if character %}
            <a href="{{ url_for('profile_by_id', char_id=character.id) }}" style="color:inherit; text-decoration: underline;">
              <strong>{{ character.name }}</strong>
            </a>
          {% else %}
            <span><strong>No character</strong></span>
          {% endif %}
        </div>
      {% endif %}
      <div class="sidebar-nav" style="width:100%;height:100%;overflow-y:auto;">
        <!-- Admin -->
        {% if current_user.is_authenticated and current_user.is_admin %}
        <div class="sidebar-category">
          <div class="sidebar-category-title collapsible" onclick="toggleSidebarCategory(this)">
            <i class="fas fa-tools"></i>&nbsp;Admin
            <span class="collapse-arrow"><i class="fas fa-chevron-down"></i></span>
          </div>
          <div class="sidebar-subnav" style="display:flex;flex-direction:column;">
            <a href="{{ url_for('admin.admin_dashboard') }}" class="{% if request.endpoint == 'admin.index' %}active{% endif %}">
              <i class="fas fa-tools"></i> <span>Admin</span>
            </a>
          </div>
        </div>
        {% endif %}
        {% if current_character.in_jail == 0 %}
        <!-- Player management -->
        <div class="sidebar-category">
          <div class="sidebar-category-title collapsible" onclick="toggleSidebarCategory(this)">
            <i class="fas fa-box"> </i>&nbsp;Character
            <span class="collapse-arrow"><i class="fas fa-chevron-down"></i></span>
          </div>
          <div class="sidebar-subnav" style="display:flex;flex-direction:column;">
            <a href="{{ url_for('dashboard') }}" class="{% if request.endpoint == 'dashboard' %}active{% endif %}">
              <i class="fas fa-home"></i> <span>Dashboard</span>
            </a>
            <a href="{{ url_for('notifications') }}" class="{% if request.endpoint == 'notifications' %}active{% endif %}">
              <i class="fas fa-concierge-bell"></i> <span>Notifications</span>
            </a>
            <a href="{{ url_for('hire_bodyguard') }}" class="{% if request.endpoint == 'hire_bodyguard' %}active{% endif %}">
              <i class="fas fa-crosshairs"></i> <span>Hire Bodyguard</span>
            </a>
            <a href="{{ url_for('inbox') }}" class="{% if request.endpoint == 'inbox' %}active{% endif %}">
              <i class="fas fa-inbox"></i> <span>Inbox</span>
            </a>
            <a href="{{ url_for('bank') }}" class="{% if request.endpoint == 'bank' %}active{% endif %}">
              <i class="fas fa-piggy-bank"></i> <span>Bank</span>
            </a>
            <a href="{{ url_for('inventory') }}" class="{% if request.endpoint == 'inventory' %}active{% endif %}">
              <i class="fas fa-box"></i> <span>Inventory</span>
            </a>
            <a href="{{ url_for('send_beer') }}" class="{% if request.endpoint == 'send_beer' %}active{% endif %}">
              <i class="fas fa-box"></i> <span>Bar</span>
            </a>
          </div>
        </div>
        {% endif %}
        {% if current_character.in_jail == 0 %}
        <!-- Dealings -->
        <div class="sidebar-category">
          <div class="sidebar-category-title collapsible" onclick="toggleSidebarCategory(this)">
            <i class="fas fa-user-alt"></i>&nbsp;Dealings
            <span class="collapse-arrow"><i class="fas fa-chevron-down"></i></span>
          </div>
          <div class="sidebar-subnav">
            <a href="{{ url_for('forums') }}" class="{% if request.endpoint == 'forums' %}active{% endif %}">
              <i class="fas fa-crosshairs"></i> <span>Forums</span>
            </a>
            <a href="{{ url_for('graveyard') }}" class="{% if request.endpoint == 'graveyard' %}active{% endif %}">
              <i class="fas fa-crosshairs"></i> <span>Graveyard</span>
            </a>
            <a href="{{ url_for('player_search') }}" class="{% if request.endpoint == 'player_search' %}active{% endif %}">
              <i class="fas fa-crosshairs"></i> <span>Player Search</span>
            </a>
            {% if character %}
            <a href="{{ url_for('city_characters', city_name=character.city) }}" class="{% if request.endpoint == 'city_characters' %}active{% endif %}">
              <i class="fas fa-crosshairs"></i> <span>City Characters</span>
            </a>
            {% endif %}
            <a href="{{ url_for('travel') }}" class="{% if request.endpoint == 'travel' %}active{% endif %}">
              <i class="fas fa-plane"></i> <span>Travel</span>
            </a>
          </div>
        </div>
        {% endif %}
        <!-- Crime -->
        <div class="sidebar-category">
          <div class="sidebar-category-title collapsible" onclick="toggleSidebarCategory(this)">
            <i class="fas fa-mask"></i>&nbsp;Crime
            <span class="collapse-arrow"><i class="fas fa-chevron-down"></i></span>
          </div>
          <div class="sidebar-subnav">
            {% if current_character.in_jail == 0 %}
            <a href="{{ url_for('shop') }}" class="{% if request.endpoint == 'shop' %}active{% endif %}">
              <i class="fas fa-store"></i> <span>Shop</span>
            </a>
            <a href="{{ url_for('create_crime') }}" class="{% if request.endpoint == 'create_crime' %}active{% endif %}">
              <i class="fas fa-mask"></i> <span>Organized Crime</span>
            </a>
            <a href="{{ url_for('drug_dashboard') }}" class="{% if request.endpoint == 'drug_dashboard' %}active{% endif %}">
              <i class="fas fa-capsules"></i> <span>Drug Market</span>
            </a>
            {% endif %}
            <a href="{{ url_for('jail') }}" class="{% if request.endpoint == 'jail' %}active{% endif %}">
              <i class="fas fa-handcuffs"></i> <span>Jail</span>
            </a>
            {% if current_character.in_jail == 0 %}
            <a href="{{ url_for('stock_market') }}" class="{% if request.endpoint == 'stock_market' %}active{% endif %}">
              <i class="fas fa-chart-line"></i> <span>Stock Market</span>
            </a>
            <a href="{{ url_for('casino') }}" class="{% if request.endpoint == 'casino' %}active{% endif %}">
              <i class="fas fa-plane"></i> <span>Casino</span>
            </a>
            {% endif %}
          </div>
        </div>
        {% if current_character.in_jail == 0 %}
        <div class="sidebar-category">
          <div class="sidebar-category-title collapsible" onclick="toggleSidebarCategory(this)">
            <i class="fas fa-home"></i>&nbsp;Manage Crew
            <span class="collapse-arrow"><i class="fas fa-chevron-down"></i></span>
          </div>
          <div class="sidebar-subnav">
            {% if current_user.is_authenticated and current_character and current_character.crew_id %}
            <a href="{{ url_for('crew_page', crew_id=current_character.crew_id) }}" class="{% if request.endpoint == 'crew_page' %}active{% endif %}">
              <i class="fas fa-users"></i> <span>Crew</span>
            </a>
            {% endif %}
            {% if is_godfather %}
              <a href="{{ url_for('crew_requests') }}">
                <i class='fas fa-people-arrows'></i><span> Crew Requests</span>
              </a>
            {% endif %}
            <a href="{{ url_for('crews', crew_id=current_character.crew_id) }}" class="{% if request.endpoint == 'crews' %}active{% endif %}">
              <i class="fas fa-users"></i> <span>Crews</span>
            </a>
            {% if current_character and current_character.level > 40 %}
            <a href="{{ url_for('godfathers_page') }}" class="{% if request.endpoint == 'godfathers_page' %}active{% endif %}">
                <i class="fas fa-crown"></i> <span>Godfathers</span>
            </a>
            {% endif %}
            <a href="{{ url_for('territories') }}" class="{% if request.endpoint == 'territories' %}active{% endif %}">
                <i class="fas fa-map"></i> <span>Territories</span>
            </a>
            
          </div>
        </div>
        {% endif %}
      </div>
      <div class="sidebar-footer">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('logout') }}" class="btn"><i id="fas-fa" class="fas fa-sign-out-alt"></i><span>Logout</span> </a>
        {% endif %}
      </div>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(24,24,36,0.7);z-index:199;transition:opacity 0.2s;opacity:0;"></div>
    {% endif %}
    {% set main_area_style = 'min-height:100vh;' + (' margin-left:220px;' if not hide_sidebar else '') %}
    {% if not hide_sidebar %}
      {% set topbar_style = 'position:fixed; top:0; z-index:100; left: 170px; width: calc(100vw - 170px);' %}
    {% else %}
      {% set topbar_style = 'position:fixed; top:0; z-index:100; left:0; width:100vw;' %}
    {% endif %}
    <div class="main-area" style="{{ main_area_style }}">
      <header class="topbar" style="{{ topbar_style }}">
        <span class="topbar-title">
          <i class="fas fa-city"></i> <a href="/"> {%block topbar_title %}Underworld Tycoon{% endblock %}</a>
        </span>
        <div class="topbar-actions">
          {% block topbar_actions %}
          {% if current_user.is_authenticated and not current_user.premium %}
          <form action="{{ url_for('upgrade') }}" method="post" class="d-inline">
            {{ upgrade_form.hidden_tag() }}
            {{ upgrade_form.submit(class_="btn") }}
          </form>
          {% elif current_user.is_authenticated and current_user.premium %}
          <span class="badge">
            <i class="fas fa-crown"></i> Premium
          </span>
          {% endif %}
          {% if current_user.is_authenticated %}
            <a href="{{ url_for('logout') }}" class="btn d-none d-md-inline-block" id="topbar-logout-btn" style="margin-left:10px;">
              <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </a>
          {% endif %}
          {% endblock %}
      
        </div>
      </header>
      <main class="content-area" style="margin-top:70px;">
        <div class="graveyard-bgbb"></div>
        <div class="graveyard-overlay"></div>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flashes">
              {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        {# --- MARKDOWN SUPPORT --- #}
        {% if markdown_content %}
          <div class="markdown-body">
            {{ markdown_content|safe }}
          </div>
        {% endif %}

        {% block content %}{% endblock %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.5.1/github-markdown.min.css">
  
{% if current_user.is_authenticated %}
  <div class="online-card-container" style="margin-top: 24px; justify-content: center;">
    <div class="online-card" style="flex-direction: column; max-width: 900px; background: rgba(24,24,36,0.92); box-shadow: 0 2px 12px #23243a55; border-radius: 14px; padding: 18px 24px;">
      <div class="online-card-header" style="margin-bottom: 10px; text-align: center;">
        <h1 style="font-size:1.2rem; color:#ffd700; margin:0 0 8px 0;"><i class="fas fa-users"></i> Online Players</h1>
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: center;">
        <span style="background: #ffd70022; color: #ffd700; font-weight: 700; border-radius: 8px; padding: 7px 16px; margin-bottom: 4px; box-shadow: 0 1px 4px #ffd70022;">{{ character.name }}</span>
        {% for char in online_characters %}
          {% if char.id != character.id %}
            <a href="{{ url_for('profile_by_id', char_id=char.id) }}" style="background: #23243a; color: #8be9fd; font-weight: 600; border-radius: 8px; padding: 7px 16px; margin-bottom: 4px; text-decoration: none; box-shadow: 0 1px 4px #8be9fd22; transition: background 0.18s, color 0.18s; display: inline-block;">
              {{ char.name }}
            </a>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}
      </main>
      <footer>
        &copy; {{ current_year if current_year else "2025" }} Underworld Tycoon - All rights reserved
      </footer>
    </div>
    {% if current_user.is_authenticated %}
    <div id="floating-chat">
      <div class="chat-header">
        <span class="chat-title"><i class="fas fa-comments"></i> Chat</span>
        <button type="button" class="chat-close" onclick="toggleChat()" title="Close chat">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="chat-tabs">
        <button type="button" id="tab-public" class="chat-tab active-tab" onclick="switchTab('public')">
          <i class="fas fa-globe"></i> Public
        </button>
        <button type="button" id="tab-crew" class="chat-tab" onclick="switchTab('crew')">
          <i class="fas fa-users"></i> Crew
        </button>
      </div>
      <div id="chat-messages" class="chat-messages"></div>
      <form id="chat-form" method="POST" autocomplete="off">
        {{ chat_form.hidden_tag() }}
        {{ chat_form.message(id="chat-input", maxlength=250, placeholder="Type a message...") }}
        <button type="submit" id="chat-submit"><i class="fas fa-paper-plane"></i></button>
      </form>
    </div>
    <button type="button" class="toggle-chat" onclick="toggleChat()" title="Show/Hide chat">
      <i class="fas fa-comments"></i>
    </button>
    {% endif %}
  </div>
  {% block extra_body %}{% endblock %}
  <script>
  // Sidebar toggle for mobile with overlay and hamburger logic
  function updateSidebarMobileState() {
    var sidebar = document.getElementById('sidebar');
    var btn = document.querySelector('.sidebar-toggle-btn');
    var overlay = document.getElementById('sidebar-overlay');
    if (!sidebar || !btn || !overlay) return;
    if (window.innerWidth <= 900) {
      btn.style.display = 'block';
      sidebar.classList.remove('open');
      sidebar.style.transform = 'translateX(-100%)';
      overlay.style.display = 'none';
      overlay.style.opacity = 0;
      document.body.style.overflow = '';
    } else {
      btn.style.display = 'none';
      sidebar.classList.remove('open');
      sidebar.style.transform = '';
      overlay.style.display = 'none';
      overlay.style.opacity = 0;
      document.body.style.overflow = '';
    }
  }
  function toggleSidebar(forceClose) {
    var sidebar = document.getElementById('sidebar');
    var btn = document.querySelector('.sidebar-toggle-btn');
    var overlay = document.getElementById('sidebar-overlay');
    if (!sidebar || !btn || !overlay) return;
    if (window.innerWidth > 900) return; // Only allow on mobile
    var isOpen = sidebar.classList.contains('open');
    if (forceClose || isOpen) {
      sidebar.classList.remove('open');
      sidebar.style.transform = 'translateX(-100%)';
      overlay.style.opacity = 0;
      setTimeout(function(){ overlay.style.display = 'none'; }, 200);
      document.body.style.overflow = '';
      btn.setAttribute('aria-expanded', 'false');
      btn.style.display = 'block'; // Show hamburger when closed
    } else {
      sidebar.classList.add('open');
      sidebar.style.transform = 'translateX(0)';
      overlay.style.display = 'block';
      setTimeout(function(){ overlay.style.opacity = 1; }, 10);
      document.body.style.overflow = 'hidden';
      btn.setAttribute('aria-expanded', 'true');
      btn.style.display = 'none'; // Hide hamburger when open
    }
  }
  // Overlay click closes sidebar
  document.addEventListener('DOMContentLoaded', function() {
    var overlay = document.getElementById('sidebar-overlay');
    if (overlay) {
      overlay.addEventListener('click', function() { toggleSidebar(true); });
    }
    updateSidebarMobileState();
  });
  // Hide sidebar on resize if desktop, show hamburger only on mobile
  window.addEventListener('resize', function() {
    updateSidebarMobileState();
  });
  // Hide sidebar on ESC key (mobile)
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && window.innerWidth <= 900) {
      toggleSidebar(true);
    }
  });
  function toggleSidebarCategory(el) {
    const category = el.parentElement;
    category.classList.toggle('collapsed');
    saveSidebarState();
    // Removed: On mobile, close sidebar after selecting a category
    // if (window.innerWidth <= 900) {
    //   toggleSidebar(true);
    // }
  }
  function saveSidebarState() {
    const states = [];
    document.querySelectorAll('.sidebar-category').forEach((cat, idx) => {
      states[idx] = cat.classList.contains('collapsed');
    });
    localStorage.setItem('sidebarCollapseStates', JSON.stringify(states));
  }
  function restoreSidebarState() {
    const states = JSON.parse(localStorage.getItem('sidebarCollapseStates') || '[]');
    const isMobile = window.matchMedia("(max-width: 991px)").matches;
    document.querySelectorAll('.sidebar-category').forEach((cat, idx) => {
      if (states.length > 0) {
        if (states[idx]) {
          cat.classList.add('collapsed');
        } else {
          cat.classList.remove('collapsed');
        }
      } else if (isMobile) {
        cat.classList.add('collapsed');
      } else {
        cat.classList.remove('collapsed');
      }
    });
  }
  window.addEventListener('resize', restoreSidebarState);
  document.addEventListener('DOMContentLoaded', function() {
    restoreSidebarState();
    // Add event listeners to sidebar links to close sidebar on mobile after click
    document.querySelectorAll('.sidebar-nav a').forEach(function(link) {
      link.addEventListener('click', function(e) {
        if (window.innerWidth <= 900) {
          // Let the navigation happen, then close the sidebar
          setTimeout(function() {
            toggleSidebar(true);
          }, 150);
        }
      });
    });
  });

  // Floating chat show/hide
  function toggleChat() {
    const chat = document.getElementById('floating-chat');
    const toggleBtn = document.querySelector('.toggle-chat');
    const isVisible = chat.style.display !== 'none';
    window.addEventListener('DOMContentLoaded', function() {
          var logDiv = document.getElementById('chat-messages');
          if (logDiv) logDiv.scrollTop = logDiv.scrollHeight; // Scroll to bottom on toggle
          });
    if (isVisible) {
      chat.style.display = 'none';
      toggleBtn.style.display = 'flex'; // Show the button when chat is hidden
      localStorage.setItem('chatVisible', 'false');
      if (window.chatPollInterval) clearInterval(window.chatPollInterval); // Stop polling
    } else {
      chat.style.display = 'flex';
      toggleBtn.style.display = 'none'; // Hide the button when chat is visible
      localStorage.setItem('chatVisible', 'true');
      fetchMessages(); // Fetch immediately
      if (window.chatPollInterval) clearInterval(window.chatPollInterval);
      window.chatPollInterval = setInterval(fetchMessages, 30000); // Restart polling
    }
    
  }

  document.addEventListener('DOMContentLoaded', () => {
    const chat = document.getElementById('floating-chat');
    const toggleBtn = document.querySelector('.toggle-chat');
    const visible = localStorage.getItem('chatVisible');
    if (visible === 'false') {
      chat.style.display = 'none';
      toggleBtn.style.display = 'flex'; // Show the button when chat is hidden
    } else {
      chat.style.display = 'flex';
      toggleBtn.style.display = 'none'; // Hide the button when chat is visible
    }
  });

  window.addEventListener('resize', () => {
    document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
  });
  document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
  
  // Floating Chat Tabs and Messaging
  let currentTab = 'public';
  let chatPollInterval = null;
  let chatPollTimeout = null;
  let chatIsRateLimited = false;

  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.chat-tab').forEach(btn => btn.classList.remove('active-tab'));
    document.getElementById(`tab-${tab}`).classList.add('active-tab');
    fetchMessages();
    // Restart polling on tab switch
    if (chatPollInterval) clearInterval(chatPollInterval);
    chatPollInterval = setInterval(fetchMessages, 1000);
  }

  async function fetchMessages() {
    if (chatIsRateLimited) return; // Prevent polling during timeout
    try {
      const res = await fetch(`/${currentTab}_messages`);
      if (res.status === 429) {
        // Stop polling to avoid spamming the server
        if (chatPollInterval) clearInterval(chatPollInterval);
          chatPollInterval = null;
          chatIsRateLimited = true; // Set rate limit flag

          // Show a user-friendly message in the chat box
          const messageBox = document.getElementById('chat-messages');
          messageBox.innerHTML = '<div class="chat-message" style="color:#ff5555;background:#23243a;">You are sending requests too quickly. Please wait 30 seconds before trying again.</div>';

        // Optionally disable chat input during timeout
        const chatInput = document.getElementById('chat-input');
        const chatSubmit = document.getElementById('chat-submit');
        if (chatInput) chatInput.disabled = true;
        if (chatSubmit) chatSubmit.disabled = true;

        // Set a timeout to resume polling after 30 seconds
        if (chatPollTimeout) clearTimeout(chatPollTimeout);
        chatPollTimeout = setTimeout(() => {
          chatIsRateLimited = false; // Reset flag
          if (chatInput) chatInput.disabled = false;
          if (chatSubmit) chatSubmit.disabled = false;
          fetchMessages();
          chatPollInterval = setInterval(fetchMessages, 3000);
        }, 30000); // 30 seconds
        return;
      }
      const data = await res.json();
      const messageBox = document.getElementById('chat-messages');
      const isNearBottom = messageBox.scrollHeight - messageBox.scrollTop <= messageBox.clientHeight + 50;
      messageBox.innerHTML = '';
      data.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'chat-message' + (msg.character_name === "{{ current_character.name }}" ? ' me' : '');
        div.innerHTML = `<span class="chat-username">${msg.character_name}</span>: ${msg.message}`;
        messageBox.appendChild(div);
      });
      if (isNearBottom) messageBox.scrollTop = messageBox.scrollHeight;
    } catch (err) {
      console.error("Error fetching messages:", err);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    switchTab('public'); // This will call fetchMessages once on load

    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    // Find the CSRF token from the FlaskForm hidden field
    const csrfInput = chatForm.querySelector('input[name="csrf_token"]');

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = chatInput.value.trim();
      if (!message) return;
      const csrfToken = csrfInput ? csrfInput.value : '';
      let url = '';
      if (currentTab === 'public') {
        url = '/send_public_message';
      } else if (currentTab === 'crew') {
        url = '/send_crew_message';
      }
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: new URLSearchParams({ message, csrf_token: csrfToken })
        });
        if (res.ok) {
          chatInput.value = '';
          fetchMessages(); // Refresh after sending a message
        } else {
          let text = await res.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch {
            alert("Server error: " + text);
            return;
          }
          alert(data.error || "Failed to send message.");
        }
      } catch (err) {
        alert("Send error: " + err);
        console.error("Send error:", err);
      }
    });

    // Start polling for new messages when chat is visible
    if (chatPollInterval) clearInterval(chatPollInterval);
    chatPollInterval = setInterval(fetchMessages, 3000);
  }, 30000);
  </script>
</body>
</html>
{% endblock %}