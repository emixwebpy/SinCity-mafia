<!DOCTYPE html>
<html lang="en">
<head>
  <title>{% block title %}Mafia Game{% endblock %}</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Bytesized&family=Geo:ital@0;1&display=swap" rel="stylesheet">
  <style>
  html {
    font-size: 14px;
    min-width: 0;
    min-height: 0;
    box-sizing: border-box;
  }
  body {
    background: radial-gradient(ellipse at top left, #23243a 0%, #1a1b2f 100%);
    color: #f5f6fa;
    font-family: "geo", sans-serif;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    width: 100vw;
    box-sizing: border-box;
  }
  .fade-in {
      animation: fadeIn 0.8s ease-in forwards;
    }
    .scale-in {
      animation: scaleIn 0.5s ease-out forwards;
    }
    @keyframes fadeIn {
      0% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    @keyframes scaleIn {
      0% { transform: scale(0.95); opacity: 0.5; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Animated dashboard cards */
    .dashboard-card {
      opacity: 0;
      transform: scale(0.95);
      animation: fadeIn 0.1s ease-out forwards;
    }
    .dashboard-card:nth-child(1) { animation-delay: 0.1s; }
    .dashboard-card:nth-child(2) { animation-delay: 0.2s; }
    .dashboard-card:nth-child(3) { animation-delay: 0.3s; }
    .dashboard-card:nth-child(4) { animation-delay: 0.4s; }

    /* Animated shop items */
    .shop-item {
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn 0.1s ease-out forwards;
    }
    .shop-item:nth-child(1) { animation-delay: 0.1s; }
    .shop-item:nth-child(2) { animation-delay: 0.2s; }
    .shop-item:nth-child(3) { animation-delay: 0.3s; }
    .shop-item:nth-child(4) { animation-delay: 0.4s; }
  .shop-container {
    width: 50%;
    max-width: 100%;
    margin: 36px auto 0 auto;
    background: rgba(25, 25, 40, 0.98);
    border-radius: 22px;
    box-shadow: 0 4px 24px #8be9fd33, 0 1.5px 0 #8be9fd22 inset;
    padding: 32px 32px 24px 32px;
    border: 1.5px solid #8be9fd44;
    color: #f5f6fa;
    
    text-align: center;
    position: relative;
    overflow: hidden;
    box-sizing: border-box;
}
@media (max-width: 900px) {
    .shop-container {
        max-width: 98vw;
        padding: 18px 2vw 14px 2vw;
    }
}
@media (max-width: 600px) {
    .shop-container {
        padding: 10px 2vw 10px 2vw;
        margin: 12px 0 0 0;
    }
}
.shop-title {
    color: #8be9fd;
    font-size: 1.5em;
    font-weight: 900;
    letter-spacing: 1px;
    margin-bottom: 24px;
    
    text-shadow: 0 2px 12px #23243a;
}
.shop-money {
    color: #ffd700;
    font-size: 1.1em;
    font-weight: 700;
    margin-bottom: 18px;
    display: block;
}
.shop-message {
    margin: 10px 0 18px 0;
    color: #8be9fd;
    font-weight: 600;
    font-size: 1em;
}
.shop-list {
    margin: 0 0 10px 0;
    padding: 0;
    list-style: none;
}
.shop-item {
    background: #35374a;
    border-radius: 12px;
    padding: 14px 20px 10px 20px;
    color: #ffd700;;
    font-size: 1.08em;
    font-weight: 500;
    box-shadow: 0 1px 6px #8be9fd22;
    border: 1px solid #8be9fd22;
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    transition: box-shadow 0.15s, transform 0.15s;
    text-align: left;
    position: relative;
}
.shop-item:last-child {
    margin-bottom: 0;
}
.shop-item:hover {
    box-shadow: 0 0px 12px #8be9fd55;
    
}
.shop-item-header {
    display: flex;
    align-items: center;
    width: 100%;
    margin-bottom: 2px;
}
.shop-item-name {
    color: #ffd700;;
    font-size: 1.08em;
    font-weight: 700;
    letter-spacing: 0.2px;
    flex: 0 0 160px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-right: 10px;
}
.shop-item-price {
    color: #ffd700;
    font-size: 1em;
    font-weight: 700;
    letter-spacing: 0.2px;
    background: rgba(139,233,253,0.12);
    border-radius: 8px;
    padding: 2px 10px;
    display: inline-block;
}
.shop-item-desc {
    color: #ffffff;
    font-size: 0.98em;
    margin-bottom: 6px;
    margin-top: 2px;
    flex: 1 1 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.shop-item-stock {
    font-size: 0.98em;
    color: #fff;
    margin-bottom: 6px;
}
.shop-item-actions {
    margin-top: 2px;
    width: 100%;
    display: flex;
    align-items: center;
    gap: 8px;
}
.shop-item-actions form {
    margin: 0;
    display: inline;
}
.shop-buy-btn {
    background: #8be9fd ;
    color: #23243a;
    border: none;
    border-radius: 10px;
    padding: 7px 22px;
    font-weight: 700;
    font-size: 1em;
    box-shadow: 0 1px 8px #8be9fd22;
    transition: background 0.18s, color 0.18s;
    cursor: pointer;
}
.shop-buy-btn:hover {
    background: #23243a;
    color: #8be9fd;
}
.shop-out {
    color: #c00;
    font-weight: 700;
    font-size: 1em;
    margin-left: 6px;
}

.shop-table {
  width: 80%;
  margin: 30px auto;
  border-collapse: collapse;
  
  background: #f8f8f8;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.shop-table th, .shop-table td {
  border: 1px solid #ddd;
  color: #222;
  padding: 12px 16px;
  text-align: center;
}
.shop-table th {
  background: #222;
  color: #ffffff;
  font-size: 1.1em;
  letter-spacing: 1px;
}
.shop-table tr:nth-child(even) {
  background: #f0f0f0;
}
.shop-table tr:hover {
  background: #e0eaff;
}
.shop-table button {
  background: #007bff;
  color: #fff;
  border: none;
  padding: 6px 14px;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
}
.badge-role {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: bold;
    text-transform: uppercase;
    margin-left: 8px;
    display: inline-block;
}
.badge-leader {
    background-color: gold;
    color: #232323;
}
.badge-right {
    background-color: #8be9fd;
    color: #1d1d1d;
}
.badge-left {
    background-color: #ff79c6;
    color: #1d1d1d;
}
.badge-member {
    background-color: #44475a;
    color: #f8f8f2;
}

  .layout-root {
    display: flex;
    min-height: 100vh;
    width: 100vw;
    overflow-x: hidden;
  }
  .sidebar {
    width: 200px;
    min-width: 48px;
    background: rgba(25, 25, 40, 0.98);
    box-shadow: 2px 0 12px rgba(30,32,60,0.10);
    display: flex;
    flex-direction: column;
    align-items: stretch;
    z-index: 100;
    transition: width 0.2s;
    border-right: 1px solid #2d2e4a;
    height: 100vh;
    position: sticky;
    top: 0;
    font-size: 18px;
    padding: 0;
  }
  .sidebar-nav {
    width: 190px;
  }
  .sidebar .sidebar-header {
    color: #8be9fd;
    font-size: 1.2em;
    font-weight: 900;
    padding: 18px 0 8px 0;
    text-align: center;
    letter-spacing: 1px;
    
    text-shadow: 0 2px 8px #23243a;
  }
  .sidebar .sidebar-user {
    color: #f5f6fa;
    text-align: center;
    margin-bottom: 12px;
    font-size: 1em;
    font-weight: 500;
    letter-spacing: 0.5px;
  }
  .sidebar .sidebar-nav {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 0;
  }
  .sidebar .sidebar-nav a {
    color: #b8b8ff;
    font-size: 0.98em;
    font-weight: 500;
    padding: 8px 18px;
    border-radius: 0 14px 14px 0;
    margin: 0 0 2px 0;
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    transition: background 0.18s, color 0.18s, padding-left 0.18s;
    position: relative;
    letter-spacing: 0.2px;
    white-space: nowrap;
  }
  .sidebar .sidebar-nav a.active,
  .sidebar .sidebar-nav a:hover {
    background: linear-gradient(90deg, #8be9fd 0%, #23243a 100%);
    color: #23243a;
    font-weight: 700;
    padding-left: 24px;
    box-shadow: 0 2px 8px #8be9fd33;
  }
  .sidebar .sidebar-footer {
    padding: 10px;
    border-top: 1px solid #2d2e4a;
  }
  .sidebar .sidebar-footer .btn {
    width: 100%;
    border-radius: 12px;
    font-weight: 600;
    background: linear-gradient(90deg, #23243a 0%, #8be9fd 100%);
    color: #fff;
    border: none;
    transition: background 0.18s, color 0.18s;
    box-shadow: 0 1px 4px #8be9fd22;
    letter-spacing: 0.5px;
    font-size: 0.95em;
    padding: 8px 0;
  }
  .sidebar .sidebar-footer .btn:hover {
    background: #8be9fd;
    color: #23243a;
  }
  .main-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    min-height: 0;
    height: 100vh;
    box-sizing: border-box;
  }
  .topbar {
    
    height: 55px;
    background: rgba(25, 25, 40, 0.98);
    display: flex;
    align-items: center;
    padding: 0 36px;
    box-shadow: 0 2px 8px #8be9fd22;
    z-index: 10;
    position: sticky;
    top: 0;
    border-bottom: 1px solid #2d2e4a;
    min-width: 0;
    font-size: 1em;
  }
  .topbar .topbar-title {
    height: 55px;
    color: #8be9fd;
    font-size: 28px;
    font-weight: 900;
    letter-spacing: 2px;
    padding-bottom: 5px;
    
    text-shadow: 0 2px 8px #23243a;
  }
  .topbar-title  {
    padding-right: auto;
    height: 55px;
    color: #8be9fd;
    text-decoration: none;
    display: flex;
    align-items: center ;
    text-align: center;
    margin: auto;
  }
  /* .topbar .topbar-actions {
    margin-left: auto;
    display: flex;
  } */
  .topbar .topbar-actions .btn {
    border-radius: 10px;
    font-weight: 600;
    background: #8be9fd;
    color: #23243a;
    border: none;
    padding: 6px 12px;
    transition: background 0.18s, color 0.18s;
    box-shadow: 0 1px 4px #8be9fd22;
    letter-spacing: 0.5px;
    font-size: 0.95em;
  }
  .topbar .topbar-actions .btn:hover {
    background: #23243a;
    color: #8be9fd;
  }
  .content-area {
    flex: 1 1 auto;
    padding: 16px 110px 12px 8px;
    min-width: 0;
    display: flex;
    flex-direction: column;
    background: none;
    font-size: 1em;
  }
  .dashboard-content-area {
    min-height: 0;
    min-width: 0;
    display: flex;
    flex-direction: column;
    background: transparent;
    box-shadow: none;
    border-radius: 0;
    padding: 12px 1vw 12px 1vw;
    box-sizing: border-box;
    width: 100%;
    justify-content: center;
    align-items: center;
  }
  .dashboard-center-container {
    width: 100%;
    max-width: 700px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .dashboard-cards {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
    justify-content: center;
    width: 100%;
  }
  .dashboard-card {
    background: rgba(139,233,253,0.10);
    border-radius: 12px;
    box-shadow: 0 2px 8px #8be9fd33;
    padding: 14px 10px;
    min-width: 160px;
    flex: 1 1 80px;
    text-align: center;
    margin: 0 0 8px 0;
    max-width: 120px;
    border: 1px solid #8be9fd44;
    transition: transform 0.15s;
    box-sizing: border-box;
    font-size: 0.95em;
  }
  .dashboard-card:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 4px 16px #8be9fd55;
  }
  .dashboard-card h5 {
    color: #8be9fd;
    font-size: 1em;
    margin-bottom: 6px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  .dashboard-card .display-4 {
    font-size: 1.3rem;
    font-weight: bold;
    color: #fff;
    letter-spacing: 0.5px;
  }
  .dashboard-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    width: 100%;
  }
  .dashboard-actions .btn {
    border-radius: 10px;
    font-weight: 600;
    background: #23243a;
    color: #8be9fd;
    border: 1px solid #8be9fd;
    padding: 8px 16px;
    transition: background 0.18s, color 0.18s, border 0.18s;
    box-shadow: 0 1px 4px #8be9fd22;
    margin-bottom: 6px;
    letter-spacing: 0.5px;
    font-size: 0.95em;
  }
  .dashboard-actions .btn:hover {
    background: #8be9fd;
    color: #23243a;
    border-color: #23243a;
  }
 
.npc-create-container{
  max-width: 600px;
  margin: 32px auto;
  padding: 24px;
  background: rgba(25,25,40,0.98);
  border: 1.5px solid #8be9fd44;
  border-radius: 22px;
  box-shadow: 0 6px 32px #8be8fd79, 0 1.5px 0 #8be9fd22 inset;
  text-align: center;
  
  color: #f5f6fa;
}
  .dashboard-premium {
    text-align: center;
    margin-bottom: 12px;
    width: 100%;
  }
  .dashboard-premium .btn {
    background: linear-gradient(90deg, #8be9fd 0%, #23243a 100%);
    color: #23243a;
    border: none;
    font-size: 1em;
    border-radius: 12px;
    padding: 8px 18px;
    box-shadow: 0 2px 8px #8be9fd33;
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  .dashboard-premium .btn:hover {
    background: #23243a;
    color: #8be9fd;
  }
  .dashboard-premium .badge {
    background: #8be9fd;
    color: #23243a;
    font-size: 1em;
    border-radius: 10px;
    padding: 6px 14px;
    box-shadow: 0 2px 8px #8be9fd33;
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  .dashboard-users-online {
    background: rgba(139,233,253,0.10);
    border-radius: 10px;
    padding: 12px;
    margin-top: 16px;
    box-shadow: 0 2px 8px #8be9fd33;
    border: 1px solid #8be9fd44;
    width: 100%;
    box-sizing: border-box;
    font-size: 0.98em;
  }
  .dashboard-users-online h2 {
    color: #8be9fd;
    margin-bottom: 8px;
    font-weight: 700;
    letter-spacing: 0.5px;
    font-size: 1em;
  }
  .dashboard-users-online ul {
    padding: 0;
    margin: 0;
    list-style: none;
  }
  .dashboard-users-online li {
    display: inline-block;
    margin: 0 6px 6px 0;
    color: #fff;
    font-size: 0.95em;
    font-weight: 500;
    letter-spacing: 0.2px;
  }
  #floating-chat {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 260px;
  height: 240px;
  border: 1px solid #8be9fd88;
  background: rgba(25, 25, 40, 0.98);
  display: flex;
  flex-direction: column;
  box-shadow: 0 0 12px #8be9fd55;
  z-index: 9999;
  border-radius: 10px;
  backdrop-filter: blur(8px);
  resize: both;
  overflow: auto;
  min-width: 160px;
  min-height: 100px;
  max-width: 98vw;
  max-height: 90vh;
  touch-action: none;
  transition: box-shadow 0.18s;
  font-size: 0.95em;
}

#floating-chat:focus-within,
#floating-chat:hover {
  box-shadow: 0 0 18px #8be9fd99;
}
  #chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 6px;
    font-size: 0.95em;
    color: #f5f6fa;
    
  }
  #chat-form {
    display: flex;
    border-top: 1px solid #8be9fd44;
    background: rgba(139,233,253,0.05);
    border-radius: 0 0 10px 10px;
  }
  #chat-input {
    flex: 1;
    border: none;
    padding: 6px;
    font-size: 0.95em;
    background: #23243a;
    color: #f5f6fa;
    border-radius: 0 0 0 10px;
    outline: none;
  }
  #chat-input::placeholder {
    color: #8be9fd;
    opacity: 0.7;
  }
  #chat-submit {
    background: #8be9fd;
    color: #23243a;
    border: none;
    padding: 6px 10px;
    cursor: pointer;
    border-radius: 0 0 10px 0;
    font-weight: 700;
    font-size: 0.95em;
    transition: background 0.18s, color 0.18s;
  }
  #chat-submit:hover {
    background: #23243a;
    color: #8be9fd;
  }
  @media (max-width: 991px) {
    html, body { font-size: 13px; }
    .content-area { padding: 6px 1vw 6px 1vw; }
    .topbar { padding: 0 2px; }
    .sidebar { width: 60px; }
    .sidebar .sidebar-header { font-size: 0.95em; padding: 8px 0 6px 0; }
    .sidebar .sidebar-nav a span { 
      display: none; 

    }
    
    .sidebar .sidebar-nav a.active,
  .sidebar .sidebar-nav a:hover {
    background: linear-gradient(180deg, #8be9fd 0%, #23243a 100%);
    color: #23243a;
    font-weight: 700;
    padding-left: 24px;
    box-shadow: 0 2px 8px #8be9fd33;
  }

    .dashboard-cards { gap: 6px; }
    .dashboard-card { min-width: 160px; padding: 8px 2px; font-size: 0.85em; max-width: 80px; }
  }
  @media (max-width: 767px) {
    html, body { font-size: 12px; }
    .layout-root { flex-direction: column; }
    .sidebar {
      flex-direction: row;
      width: 100vw;
      height: 36px;
      padding: 0;
      box-shadow: 0 2px 8px #8be9fd22;
      position: static;
      min-width: 0;
      min-height: 0;
      height: auto;
    }
    .sidebar .sidebar-header { font-size: 0.8em; margin-bottom: 0; margin-right: 0; padding: 0 10px; }
    .sidebar .sidebar-nav {align-items: center;  flex-direction: row; gap: 20px;padding: 0 10px; }
    .sidebar .sidebar-nav a { font-size: 0.85em; padding: 4px 4px; border-radius: 4px; }
    .sidebar .sidebar-nav a span { display: none !important; }
    .sidebar .sidebar-footer { padding: 2px; border-top: none; margin-left: auto; }
    .main-area { margin-left: 0; min-height: 0; height: auto; }
    .content-area { padding: 2vw 1vw 1vw 1vw; min-height: 0; height: auto; }
    .dashboard-cards { flex-direction: column; gap: 4px; align-items: stretch; }
    .dashboard-card { min-width: 0; max-width: 100vw; width: 100%; padding: 4px 2px; font-size: 0.85em; }
    .sidebar title{
      padding-right: auto;
      height: 55px;
      color: #8be9fd;
      text-decoration: none;
      display: flex;
      align-items: center ;
      text-align: center;
      margin: auto;}
      
      #floating-chat {
      width: 92vw;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 220px;
      height: 200px;
      bottom: 90px; /* ⬅️ leaves space for users-online or bottom nav */
      
      min-height: 100px;
      max-height: 60vh;
      resize: none;
      font-size: 1.15em;
  }

  #chat-input {
    font-size: 0.85em;
    padding: 5px;
  }

  #chat-submit {
    font-size: 0.85em;
    padding: 5px 10px;
  }

  #chat-messages {
    padding: 4px;
    font-size: 0.85em;
  }
}
  .flashes {
    text-align: center;
    list-style: none;
    padding: 0;
    text-align: center;
    margin: 0 0 12px 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  footer {
    text-align: center;
    font-size: 0.9em;
    padding: 4px 0;
  }
  .d-none {
  display: none !important;
  }
  
  </style>
  {% block extra_head %}{% endblock %}
</head>
<body>
  <body class="fade-in">
  <div class="layout-root fade-in">
  <div class="layout-root">
    <div class="sidebar {% if request.endpoint in ['login', 'register'] %}d-none{% endif %}">
    <nav class="sidebar">
      <div class="sidebar-header">
        <i class="fas fa-crown"></i>
      </div>
      {% if current_user.is_authenticated %}
      <div class="sidebar-user">
        <i class="fas fa-user-circle"></i>
          <a href="{{ url_for('profile', username=current_user.username) }}" style="color:inherit; text-decoration: underline;">
                      
          <strong>{{ current_character.name }}</strong>
          </a>
          
      </div>
      {% endif %}

      <div class="sidebar-nav">
        <a href="{{ url_for('dashboard') }}" class="{% if request.endpoint == 'dashboard' %}active{% endif %}">
          <i class="fas fa-home"></i> <span>Dashboard</span>
        </a>
        <a href="{{ url_for('shop') }}" class="{% if request.endpoint == 'shop' %}active{% endif %}">
          <i class="fas fa-store"></i> <span>Shop</span>
        </a>
        <a href="{{ url_for('inventory') }}" class="{% if request.endpoint == 'inventory' %}active{% endif %}">
          <i class="fas fa-box"></i> <span>Inventory</span>
        </a>
        <a href="{{ url_for('player_search') }}" class="{% if request.endpoint == 'player_search' %}active{% endif %}">
            <i class="fas fa-crosshairs"></i> <span>Player Search</span>
        </a>
        {% if current_user.is_authenticated and current_user.is_admin %}
        <a href="{{ url_for('admin.index') }}" class="{% if request.endpoint == 'admin.index' %}active{% endif %}">
          <i class="fas fa-tools"></i> <span>Admin</span>
        </a>
        {% endif %}
      </div>
      <div class="sidebar-footer">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('logout') }}" class="btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        {% endif %}
      </div>
    </nav>
    </div>
    <div class="main-area">
      <header class="topbar">
        <span class="topbar-title">
          {% block topbar_title %}Sin City{% endblock %}
        </span>
        <div class="topbar-actions">
          {% block topbar_actions %}
          {% if current_user.is_authenticated and not current_user.premium %}
          <form action="{{ url_for('upgrade') }}" method="post" class="d-inline">
            <button type="submit" class="btn">
              <i class="fas fa-star"></i> Upgrade
            </button>
          </form>
          {% elif user.is_authenticated and user.premium %}
          <span class="badge badge-success p-2" style="font-size:1em;">
            <i class="fas fa-crown"></i> Premium
          </span>
          {% endif %}
          {% endblock %}
        </div>
      </header>
      <main class="content-area">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flashes">
              {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
      </main>
      <footer>
        &copy; {{ current_year if current_year else "2025" }} Sin City - All rights reserved
      </footer>
    </div>
    
    <div id="floating-chat">
      
    <div id="chat-messages"></div>
    <form id="chat-form">
        <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off" />
        <button type="submit" id="chat-submit">Send</button>
    </form>
    
  </div>
  <button class="toggle-chat" onclick="toggleChat()" style="
      position: fixed;
      bottom: 229px;
      right: 20px;
      z-index: 10000;
      background: #8be9fd;
      color: #23243a;
      padding: 6px 10px;
      border-radius: 8px;
      border: none;
      font-weight: 700;
    ">-</button>
</div>
</div>
  {% block extra_body %}{% endblock %}
</body>
<script >
  src="{{ url_for('static', filename='js/earn.js') }}"


  function toggleChat() {
  const chat = document.getElementById('floating-chat');
  const isVisible = chat.style.display !== 'none';

  if (isVisible) {
    chat.style.display = 'none';
    localStorage.setItem('chatVisible', 'false');
  } else {
    chat.style.display = 'flex';
    localStorage.setItem('chatVisible', 'true');
  }
}

// On page load: apply saved state
document.addEventListener('DOMContentLoaded', () => {
  const chat = document.getElementById('floating-chat');
  const visible = localStorage.getItem('chatVisible');

  if (visible === 'false') {
    chat.style.display = 'none';
  } else {
    chat.style.display = 'flex'; // or 'block' depending on your CSS
  }
});
  // ---------------- Floating Chat ----------------
document.addEventListener('DOMContentLoaded', () => {
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const chatMessages = document.getElementById('chat-messages');

  async function fetchMessages() {
    try {
      const res = await fetch('/crew_messages');
      const data = await res.json();
      chatMessages.innerHTML = '';
      data.forEach(msg => {
        const div = document.createElement('div');
        div.textContent = `${msg.username}: ${msg.message}`;
        chatMessages.appendChild(div);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (err) {
      console.error('Failed to fetch messages:', err);
    }
  }

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (!message) return;

    try {
      const res = await fetch('/send_crew_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ message })
      });

      if (res.ok) {
        chatInput.value = '';
        fetchMessages();
      } else {
        const error = await res.json();
        alert(error.error || 'Failed to send message.');
      }
    } catch (err) {
      console.error('Send failed:', err);
    }
  });

  fetchMessages();
  setInterval(fetchMessages, 3000);
});
</script>
</html>
