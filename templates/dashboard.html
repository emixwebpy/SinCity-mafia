{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
  <a href="{{ url_for('admin.index') }}">
    <button>Admin</button>
  </a>
  <hr>
  <h1>Dashboard</h1>
  
  {% if current_user.is_admin %}
    <p>You are logged in as an admin.</p>
  {% endif %}
  
  {% if current_user.is_moderator %}
    <p>You are logged in as a moderator.</p>
  {% endif %}

  {% if current_user.is_banned %}
    <p class="error">You are banned from the game.</p>
  {% endif %}

  {% if current_user.is_suspended %}
    <p class="error">Your account is suspended.</p>
  {% endif %}

  {% if current_user.is_verified %}
    <p>Your account is verified.</p>
  {% else %}
    <p class="warning">Your account is not verified. Please check your email.</p>
  {% endif %}

  {% if current_user.is_premium %}
    <p>You have a premium account.</p>
  {% else %}
    <p>You do not have a premium account.</p>
  {% endif %}
  <h2>Welcome, {{ current_user.username }}!</h2>
   
  <p>Money: {{ current_user.money }}</p>
  <p>XP: {{ user.xp }}</p>
  <p>Level: {{ current_user.level }}</p>
  <a href="{{ url_for('shop') }}">Go to Shop</a>
  <a href="{{ url_for('inventory') }}">View Inventory</a>
  {% if current_user.crew %}
    <p>You are in crew: <a href="{{ url_for('crew_page', crew_id=crew.id) }}">{{ crew.name }}</a></strong></p>
    
  
    <form action="{{ url_for('leave_crew') }}" method="POST" style="display:inline;">
      <button type="submit" onclick="return confirm('Are you sure you want to leave your crew?')">Leave Crew</button>
    </form>
  {% else %}
    <p>You are not in any crew yet.</p>
    <a href="{{ url_for('create_crew') }}">
      <button>Create a Crew</button>
    </a>
    <a href="{{ url_for('join_crew') }}">
      <button>Join a Crew</button>
    </a>
  {% endif %}
    
  <button id="earn-btn" onclick="earn()">Earn<span id="earn-timer"></span></button>


  <a href="{{ url_for('logout') }}">
    <button>Logout</button>
  </a>
  
  <form action="{{ url_for('invite_to_crew') }}" method="POST" class="invite-form">

    <button type="submit" class="invite-btn">
      <span class="btn-text">Send Invite</span>
      <span class="btn-icon">ðŸ“¨</span>
    </button>
  </form>
  <div>
    <h2>Users Online</h2>
    {% if online_users %}
      <ul id="users-online-list">
        {% for user in online_users %}
          <li>{{ user.username }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No users online right now.</p>
    {% endif %}
  </div>
  <style>
    #floating-chat {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 300px;
  height: 400px;
  border: 1px solid #444;
  background: #1e1e1e;
  display: flex;
  flex-direction: column;
  box-shadow: 0 0 10px rgba(0,0,0,0.6);
  z-index: 9999;
  border-radius: 6px;
}

#chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  font-size: 14px;
  color: #e0e0e0;
}

#chat-form {
  display: flex;
  border-top: 1px solid #444;
}

#chat-input {
  flex: 1;
  border: none;
  padding: 10px;
  font-size: 14px;
  background: #2c2c2c;
  color: #f0f0f0;
}

#chat-input::placeholder {
  color: #888;
}

#chat-submit {
  background: #007bff;
  color: white;
  border: none;
  padding: 10px 15px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

#chat-submit:hover {
  background: #0056b3;
}

  </style>
  

  <div id="floating-chat">
    <div id="chat-messages"></div>
    <form id="chat-form">
      <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off" />
      <button type="submit" id="chat-submit">Send</button>
    </form>
  </div>

  <script>
let earnTimerInterval = null; // global to track and clear the countdown

// ---------------- Earn Button Timer ----------------
async function updateEarnButton() {
  const res = await fetch('/earn_status');
  const data = await res.json();
  const btn = document.getElementById('earn-btn');
  const timerSpan = document.getElementById('earn-timer');

  if (earnTimerInterval) {
    clearInterval(earnTimerInterval);
    earnTimerInterval = null;
  }

  if (data.seconds_remaining > 0) {
    btn.disabled = true;
    let seconds = data.seconds_remaining;

    earnTimerInterval = setInterval(() => {
      if (seconds <= 0) {
        clearInterval(earnTimerInterval);
        earnTimerInterval = null;
        btn.disabled = false;
        timerSpan.textContent = '';
      } else {
        let min = Math.floor(seconds / 60);
        let sec = seconds % 60;
        timerSpan.textContent = ` (Wait ${min}:${sec.toString().padStart(2, '0')})`;
        seconds--;
      }
    }, 1000);
  } else {
    btn.disabled = false;
    timerSpan.textContent = '';
  }
}

updateEarnButton();
setInterval(updateEarnButton, 15000);

async function earn() {
  const res = await fetch('/earn');
  const data = await res.json();

  alert(data.message);
  updateEarnButton();
}

// ---------------- Floating Chat ----------------
document.addEventListener('DOMContentLoaded', () => {
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const chatMessages = document.getElementById('chat-messages');

  async function fetchMessages() {
    try {
      const res = await fetch('/crew_messages');
      const data = await res.json();
      chatMessages.innerHTML = '';
      data.forEach(msg => {
        const div = document.createElement('div');
        div.textContent = `${msg.username}: ${msg.message}`;
        chatMessages.appendChild(div);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (err) {
      console.error('Failed to fetch messages:', err);
    }
  }

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (!message) return;

    try {
      const res = await fetch('/send_crew_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ message })
      });

      if (res.ok) {
        chatInput.value = '';
        fetchMessages();
      } else {
        const error = await res.json();
        alert(error.error || 'Failed to send message.');
      }
    } catch (err) {
      console.error('Send failed:', err);
    }
  });

  fetchMessages();
  setInterval(fetchMessages, 3000);
});
</script>

{% endblock %}
