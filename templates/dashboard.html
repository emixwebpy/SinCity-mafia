{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
.dashboard-root {
    width: 100%;
    min-height: 100vh;
    background: none;
}
.dashboard-center-container {
    width: 100%;
    max-width: 1100px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
}
.dashboard-cards {
    display: flex;
    gap: 36px;
    margin-bottom: 36px;
    flex-wrap: wrap;
    justify-content: center;
    width: 100%;
}
.dashboard-card {
    background: linear-gradient(135deg, #23243a 60%, #8be9fd22 100%);
    border-radius: 22px;
    box-shadow: 0 4px 24px #8be9fd33, 0 1.5px 0 #8be9fd22 inset;
    padding: 38px 36px 32px 36px;
    min-width: 180px;
    flex: 1 1 180px;
    text-align: center;
    margin: 0 0 18px 0;
    max-width: 260px;
    border: 1.5px solid #8be9fd44;
    transition: transform 0.15s, box-shadow 0.15s;
    box-sizing: border-box;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 0; /* allow children to shrink */
}
.dashboard-card:hover {
    transform: translateY(-6px) scale(1.04);
    box-shadow: 0 8px 32px #8be9fd55;
}
.dashboard-card h5 {
    color: #8be9fd;
    font-size: 1.3em;
    margin-bottom: 14px;
    font-weight: 700;
    letter-spacing: 1px;
    text-shadow: 0 2px 12px #23243a;
}
.dashboard-card .display-4 {
    display: block;
    width: 100%;
    min-width: 0;
    font-size: clamp(1.2rem, 5vw, 2.6rem); /* shrink on small screens */
    font-weight: bold;
    color: #ffd700;
    letter-spacing: 1px;
    text-shadow: 0 2px 12px #23243a;
    word-break: break-all;
    overflow-wrap: anywhere;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap; /* single line, shrinks instead of wrapping */
    text-align: center;
}
.dashboard-actions {
    display: flex;
    gap: 18px;
    justify-content: center;
    margin-bottom: 36px;
    flex-wrap: wrap;
    width: 100%;
}
.dashboard-actions .btn {
    border-radius: 16px;
    font-weight: 600;
    background: #23243a;
    color: #8be9fd;
    border: 1.5px solid #8be9fd;
    padding: 14px 32px;
    transition: background 0.18s, color 0.18s, border 0.18s;
    box-shadow: 0 1px 8px #8be9fd22;
    margin-bottom: 10px;
    letter-spacing: 1px;
}
.dashboard-actions .btn:hover {
    background: #8be9fd;
    color: #23243a;
    border-color: #23243a;
}
.invite-form .btn-info {
    border-radius: 14px;
    font-weight: 600;
    background: linear-gradient(90deg, #8be9fd 0%, #23243a 100%);
    color: #23243a;
    border: none;
    padding: 10px 28px;
    box-shadow: 0 1px 8px #8be9fd22;
    font-size: 1.08em;
    margin-top: 8px;
    transition: background 0.18s, color 0.18s;
}
.invite-form .btn-info:hover {
    background: #23243a;
    color: #8be9fd;
}
.dashboard-users-online {
    background: rgba(139,233,253,0.10);
    border-radius: 18px;
    padding: 28px;
    margin-top: 36px;
    box-shadow: 0 2px 12px #8be9fd33;
    border: 1.5px solid #8be9fd44;
    width: 100%;
    box-sizing: border-box;
    text-align: left;
}
.dashboard-users-online h2 {
    color: #8be9fd;
    margin-bottom: 18px;
    font-weight: 700;
    letter-spacing: 1px;
    font-size: 1.3em;
}
.dashboard-users-online ul {
    padding: 0;
    margin: 0;
    list-style: none;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.dashboard-users-online li {
    background: rgba(139,233,253,0.08);
    border-radius: 10px;
    padding: 6px 16px;
    color: #fff;
    font-size: 1.05em;
    font-weight: 500;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    box-shadow: 0 1px 4px #8be9fd22;
    transition: background 0.15s;
}
.dashboard-users-online li:hover {
    background: #8be9fd;
    color: #23243a;
}
@media (max-width: 991px) {
    .dashboard-center-container {
        max-width: 98vw;
    }
    .dashboard-cards {
        gap: 16px;
    }
    .dashboard-card {
        min-width: 120px;
        padding: 18px 8px;
        font-size: 0.95em;
        max-width: 180px;
    }
}
@media (max-width: 767px) {
    .dashboard-cards {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
    }
    .dashboard-card {
        min-width: 0;
        max-width: 100vw;
        width: 100%;
        padding: 12px 6px;
        font-size: 0.95em;
    }
    .dashboard-users-online {
        padding: 12px;
    }
}
@media (max-width: 500px) {
    .dashboard-card .display-4 {
        font-size: 1.3rem;
    }
}
</style>

<div class="dashboard-root">
    <div class="main-area">
        <main class="dashboard-content-area">
            <div class="dashboard-center-container">
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <h5><i class="fas fa-money-bill-wave"></i> Money</h5>
                        <div class="display-4" id="money">${{ current_character.money }}</div>
                    </div>
                    <div class="dashboard-card">
                        <h5><i class="fas fa-star"></i> XP</h5>
                        <div class="display-4" id="xp">{{ current_character.xp }}</div>
                    </div>
                    <div class="dashboard-card">
                        <h5><i class="fas fa-layer-group"></i> Level</h5>
                        <div class="display-4" id="level">{{ current_character.level }}</div>
                    </div>
                </div>
                <div class="dashboard-actions">
                    {% if current_user.crew %}
                    <a href="{{ url_for('crew_page', crew_id=crew.id) }}" class="btn"><i class="fas fa-users"></i> Crew</a>
                    <form action="{{ url_for('leave_crew') }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to leave your crew?')">Leave Crew</button>
                    </form>
                    {% else %}
                    <a href="{{ url_for('create_crew') }}" class="btn"><i class="fas fa-plus"></i> Create Crew</a>
                    <a href="{{ url_for('join_crew') }}" class="btn"><i class="fas fa-sign-in-alt"></i> Join Crew</a>
                    {% endif %}
                </div>
                <form action="{{ url_for('invite_to_crew') }}" method="POST" class="invite-form text-center mb-3">
                    <button type="submit" class="btn btn-info">
                        <span class="btn-text">Send Invite</span>
                        <span class="btn-icon">ðŸ“¨</span>
                    </button>
                </form>
                <div class="text-center my-4">
                    <button id="earn-btn" class="btn btn-lg btn-primary shadow" onclick="earn()">
                        <i class="fas fa-coins"></i> Earn <span id="earn-timer"></span>
                    </button>
                </div>
                <div class="dashboard-users-online">
                    <h2><i class="fas fa-user-friends"></i> Users Online</h2>
                    {% if online_users %}
                    <ul id="users-online-list">
                        {% for user in online_users %}
                        <li>
                            <a href="{{ url_for('profile', username=user.username) }}" style="color:inherit;text-decoration:underline;">
                                {{ char_map[user.id].name if user.id in char_map else user.username }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>No users online right now.</p>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>
</div>

<div id="floating-chat">
    <div id="chat-messages"></div>
    <form id="chat-form">
        <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off" />
        <button type="submit" id="chat-submit">Send</button>
    </form>
</div>

<script>
// ---------------- Earn Button Timer ----------------
let earnTimerInterval = null; // global to track and clear the countdown

async function updateEarnButton() {
  const res = await fetch('/earn_status');
  const data = await res.json();
  const btn = document.getElementById('earn-btn');
  const timerSpan = document.getElementById('earn-timer');

  if (earnTimerInterval) {
    clearInterval(earnTimerInterval);
    earnTimerInterval = null;
  }

  if (data.seconds_remaining > 0) {
    btn.disabled = true;
    let seconds = data.seconds_remaining;

    earnTimerInterval = setInterval(() => {
      if (seconds <= 0) {
        clearInterval(earnTimerInterval);
        earnTimerInterval = null;
        btn.disabled = false;
        timerSpan.textContent = '';
      } else {
        let min = Math.floor(seconds / 60);
        let sec = seconds % 60;
        timerSpan.textContent = ` (Wait ${min}:${sec.toString().padStart(2, '0')})`;
        seconds--;
      }
    }, 1000); // Update every second
  } else {
    btn.disabled = false;
    timerSpan.textContent = '';
  }
}

updateEarnButton();
setInterval(updateEarnButton, 15000); // Update every 15 seconds

async function earn() {
  const res = await fetch('/earn');
  const data = await res.json();

  if (data.success) {
    const statsRes = await fetch('/user_stats');
    const stats = await statsRes.json();
    document.getElementById('money').textContent = stats.money;
    document.getElementById('xp').textContent = stats.xp;
    document.getElementById('level').textContent = stats.level;
  }
  updateEarnButton();
}

// ---------------- Floating Chat ----------------
document.addEventListener('DOMContentLoaded', () => {
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const chatMessages = document.getElementById('chat-messages');

  async function fetchMessages() {
    try {
      const res = await fetch('/crew_messages');
      const data = await res.json();
      chatMessages.innerHTML = '';
      data.forEach(msg => {
        const div = document.createElement('div');
        div.textContent = `${msg.username}: ${msg.message}`;
        chatMessages.appendChild(div);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (err) {
      console.error('Failed to fetch messages:', err);
    }
  }

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (!message) return;

    try {
      const res = await fetch('/send_crew_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ message })
      });

      if (res.ok) {
        chatInput.value = '';
        fetchMessages();
      } else {
        const error = await res.json();
        alert(error.error || 'Failed to send message.');
      }
    } catch (err) {
      console.error('Send failed:', err);
    }
  });

  fetchMessages();
  setInterval(fetchMessages, 3000);
});
</script>
{% endblock %}
