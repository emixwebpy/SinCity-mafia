{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
  <div class="container min-vh-100 d-flex flex-column justify-content-center align-items-center">

  {% if current_user.is_authenticated and current_user.is_admin %}
    <a href="{{ url_for('admin.index') }}">
      <button class="btn btn-warning mb-3">Admin</button>
    </a>
  {% endif %}
  <hr class="w-100">

  <h1 class="text-center mb-3">Dashboard</h1>
  
  {% if current_user.is_admin %}
    <p class="text-center">You are logged in as an admin.</p>
  {% endif %}

  <div class="my-4 text-center w-100">
    {% if current_user.is_authenticated and not current_user.premium %}
      <form action="{{ url_for('upgrade') }}" method="post" class="d-inline">
        <button type="submit" class="btn btn-lg btn-success shadow">
          <i class="fas fa-star"></i> Upgrade to <strong>Premium</strong>
        </button>
      </form>
    {% elif current_user.premium %}
      <span class="badge badge-success p-3" style="font-size:1.2em;">
        <i class="fas fa-crown"></i> Premium Account
      </span>
    {% endif %}
  </div>
  
  <h2 class="text-center mb-4">Welcome, {{ current_user.username }}!</h2>
   
  <div class="row justify-content-center my-4 w-100">
    <div class="col-md-4 d-flex justify-content-center">
      <div class="card text-center shadow w-100">
        <div class="card-body">
          <h5 class="card-title">Money</h5>
          <p class="card-text display-4" id="money">${{ current_user.money }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 d-flex justify-content-center">
      <div class="card text-center shadow w-100">
        <div class="card-body">
          <h5 class="card-title">XP</h5>
          <p class="card-text display-4" id="xp">{{ current_user.xp }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 d-flex justify-content-center">
      <div class="card text-center shadow w-100">
        <div class="card-body">
          <h5 class="card-title">Level</h5>
          <p class="card-text display-4" id="level">{{ current_user.level }}</p>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex flex-row justify-content-center mb-4">
    <a href="{{ url_for('shop') }}" class="btn btn-outline-primary mx-2">Go to Shop</a>
    <a href="{{ url_for('inventory') }}" class="btn btn-outline-info mx-2">View Inventory</a>
  </div>

  {% if current_user.crew %}
    <p class="text-center">You are in crew: <a href="{{ url_for('crew_page', crew_id=crew.id) }}">{{ crew.name }}</a></p>
    <form action="{{ url_for('leave_crew') }}" method="POST" class="d-inline">
      <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to leave your crew?')">Leave Crew</button>
    </form>
  {% else %}
    <p class="text-center">You are not in any crew yet.</p>
    <div class="d-flex flex-row justify-content-center mb-3">
      <a href="{{ url_for('create_crew') }}" class="btn btn-outline-success mx-2">Create a Crew</a>
      <a href="{{ url_for('join_crew') }}" class="btn btn-outline-secondary mx-2">Join a Crew</a>
    </div>
  {% endif %}

  <form action="{{ url_for('invite_to_crew') }}" method="POST" class="invite-form text-center mb-3">
    <button type="submit" class="btn btn-info">
      <span class="btn-text">Send Invite</span>
      <span class="btn-icon">ðŸ“¨</span>
    </button>
  </form>
  
  <div class="text-center my-4">
    <button id="earn-btn" class="btn btn-lg btn-primary shadow" onclick="earn()">
      <i class="fas fa-coins"></i> Earn <span id="earn-timer"></span>
    </button>
  </div>

  <a href="{{ url_for('logout') }}">
    <button class="btn btn-outline-danger">Logout</button>
  </a>
  
  <div class="w-100 text-center mt-4">
    <h2>Users Online</h2>
    {% if online_users %}
      <ul id="users-online-list" class="list-inline">
        {% for user in online_users %}
          <li class="list-inline-item">{{ user.username }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No users online right now.</p>
    {% endif %}
  </div>

  <style>
    .display-4 {
      font-size: 2.5rem;
      font-weight: bold;
    }
    #floating-chat {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      height: 400px;
      border: 1px solid #444;
      background: #1e1e1e;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      z-index: 9999;
      border-radius: 6px;
    }
    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      font-size: 14px;
      color: #e0e0e0;
    }
    #chat-form {
      display: flex;
      border-top: 1px solid #444;
    }
    #chat-input {
      flex: 1;
      border: none;
      padding: 10px;
      font-size: 14px;
      background: #2c2c2c;
      color: #f0f0f0;
    }
    #chat-input::placeholder {
      color: #888;
    }
    #chat-submit {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #chat-submit:hover {
      background: #0056b3;
    }
  </style>

  <div id="floating-chat">
    <div id="chat-messages"></div>
    <form id="chat-form">
      <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off" />
      <button type="submit" id="chat-submit">Send</button>
    </form>
  </div>
  <script>


// ---------------- Earn Button Timer ----------------
let earnTimerInterval = null; // global to track and clear the countdown

// ---------------- Earn Button Timer ----------------
async function updateEarnButton() {
  const res = await fetch('/earn_status');
  const data = await res.json();
  const btn = document.getElementById('earn-btn');
  const timerSpan = document.getElementById('earn-timer');

  if (earnTimerInterval) {
    clearInterval(earnTimerInterval);
    earnTimerInterval = null;
  }

  if (data.seconds_remaining > 0) {
    btn.disabled = true;
    let seconds = data.seconds_remaining;

    earnTimerInterval = setInterval(() => {
      if (seconds <= 0) {
        clearInterval(earnTimerInterval);
        earnTimerInterval = null;
        btn.disabled = false;
        timerSpan.textContent = '';
      } else {
        let min = Math.floor(seconds / 60);
        let sec = seconds % 60;
        timerSpan.textContent = ` (Wait ${min}:${sec.toString().padStart(2, '0')})`;
        seconds--;
      }
    }, 1000); // Update every second
  } else {
    btn.disabled = false;
    timerSpan.textContent = '';
  }
}

updateEarnButton();
setInterval(updateEarnButton, 15000); // Update every 15 seconds

async function earn() {
  const res = await fetch('/earn');
  const data = await res.json();

  // Remove the alert and update the UI instead
  if (data.success) {
    // Fetch updated stats from the server
    const statsRes = await fetch('/user_stats');
    const stats = await statsRes.json();
    document.getElementById('money').textContent = stats.money;
    document.getElementById('xp').textContent = stats.xp;
    document.getElementById('level').textContent = stats.level;
  }
  updateEarnButton();
}

// ---------------- Floating Chat ----------------
document.addEventListener('DOMContentLoaded', () => {
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const chatMessages = document.getElementById('chat-messages');

  async function fetchMessages() {
    try {
      const res = await fetch('/crew_messages');
      const data = await res.json();
      chatMessages.innerHTML = '';
      data.forEach(msg => {
        const div = document.createElement('div');
        div.textContent = `${msg.username}: ${msg.message}`;
        chatMessages.appendChild(div);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (err) {
      console.error('Failed to fetch messages:', err);
    }
  }

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (!message) return;

    try {
      const res = await fetch('/send_crew_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ message })
      });

      if (res.ok) {
        chatInput.value = '';
        fetchMessages();
      } else {
        const error = await res.json();
        alert(error.error || 'Failed to send message.');
      }
    } catch (err) {
      console.error('Send failed:', err);
    }
  });

  fetchMessages();
  setInterval(fetchMessages, 3000);
});
</script>
</div>
{% endblock %}
