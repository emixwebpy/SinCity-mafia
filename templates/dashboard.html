{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}


<div class="dashboard-root">
    <div class="main-area">
        <main class="dashboard-content-area">
            <div class="dashboard-center-container">
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <h5>Money</h5>
                        <div class="display-4" id="money">${{ current_user.money }}</div>
                    </div>
                    <div class="dashboard-card">
                        <h5>XP</h5>
                        <div class="display-4" id="xp">{{ current_user.xp }}</div>
                    </div>
                    <div class="dashboard-card">
                        <h5>Level</h5>
                        <div class="display-4" id="level">{{ current_user.level }}</div>
                    </div>
                </div>
                <div class="dashboard-actions">
                    {% if current_user.crew %}
                    <a href="{{ url_for('crew_page', crew_id=crew.id) }}" class="btn"><i class="fas fa-users"></i> Crew</a>
                    <form action="{{ url_for('leave_crew') }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to leave your crew?')">Leave Crew</button>
                    </form>
                    {% else %}
                    <a href="{{ url_for('create_crew') }}" class="btn"><i class="fas fa-plus"></i> Create Crew</a>
                    <a href="{{ url_for('join_crew') }}" class="btn"><i class="fas fa-sign-in-alt"></i> Join Crew</a>
                    {% endif %}
                </div>
                <form action="{{ url_for('invite_to_crew') }}" method="POST" class="invite-form text-center mb-3">
                    <button type="submit" class="btn btn-info">
                        <span class="btn-text">Send Invite</span>
                        <span class="btn-icon">ðŸ“¨</span>
                    </button>
                </form>
                <div class="text-center my-4">
                    <button id="earn-btn" class="btn btn-lg btn-primary shadow" onclick="earn()">
                        <i class="fas fa-coins"></i> Earn <span id="earn-timer"></span>
                    </button>
                </div>
                <div class="dashboard-users-online">
                    <h2>Users Online</h2>
                    {% if online_users %}
                    <ul id="users-online-list">
                        {% for user in online_users %}
                        <li>
                            <a href="{{ url_for('profile', username=user.username) }}" style="color:inherit;text-decoration:underline;">
                                {{ user.username }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>No users online right now.</p>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>
</div>

<div id="floating-chat">
    <div id="chat-messages"></div>
    <form id="chat-form">
        <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off" />
        <button type="submit" id="chat-submit">Send</button>
    </form>
</div>

<script>
// ---------------- Earn Button Timer ----------------
let earnTimerInterval = null; // global to track and clear the countdown

async function updateEarnButton() {
  const res = await fetch('/earn_status');
  const data = await res.json();
  const btn = document.getElementById('earn-btn');
  const timerSpan = document.getElementById('earn-timer');

  if (earnTimerInterval) {
    clearInterval(earnTimerInterval);
    earnTimerInterval = null;
  }

  if (data.seconds_remaining > 0) {
    btn.disabled = true;
    let seconds = data.seconds_remaining;

    earnTimerInterval = setInterval(() => {
      if (seconds <= 0) {
        clearInterval(earnTimerInterval);
        earnTimerInterval = null;
        btn.disabled = false;
        timerSpan.textContent = '';
      } else {
        let min = Math.floor(seconds / 60);
        let sec = seconds % 60;
        timerSpan.textContent = ` (Wait ${min}:${sec.toString().padStart(2, '0')})`;
        seconds--;
      }
    }, 1000); // Update every second
  } else {
    btn.disabled = false;
    timerSpan.textContent = '';
  }
}

updateEarnButton();
setInterval(updateEarnButton, 15000); // Update every 15 seconds

async function earn() {
  const res = await fetch('/earn');
  const data = await res.json();

  if (data.success) {
    const statsRes = await fetch('/user_stats');
    const stats = await statsRes.json();
    document.getElementById('money').textContent = stats.money;
    document.getElementById('xp').textContent = stats.xp;
    document.getElementById('level').textContent = stats.level;
  }
  updateEarnButton();
}

// ---------------- Floating Chat ----------------
document.addEventListener('DOMContentLoaded', () => {
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const chatMessages = document.getElementById('chat-messages');

  async function fetchMessages() {
    try {
      const res = await fetch('/crew_messages');
      const data = await res.json();
      chatMessages.innerHTML = '';
      data.forEach(msg => {
        const div = document.createElement('div');
        div.textContent = `${msg.username}: ${msg.message}`;
        chatMessages.appendChild(div);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (err) {
      console.error('Failed to fetch messages:', err);
    }
  }

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (!message) return;

    try {
      const res = await fetch('/send_crew_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ message })
      });

      if (res.ok) {
        chatInput.value = '';
        fetchMessages();
      } else {
        const error = await res.json();
        alert(error.error || 'Failed to send message.');
      }
    } catch (err) {
      console.error('Send failed:', err);
    }
  });

  fetchMessages();
  setInterval(fetchMessages, 3000);
});
</script>
{% endblock %}
