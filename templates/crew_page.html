{% extends "base.html" %}
{% block content %}
<style>
.forums-header {
    background: linear-gradient(90deg, #232526 0%, #414345 100%);
    padding: 2rem 2rem 1rem 2rem;
    border-radius: 12px 12px 0 0;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    margin-bottom: 0;
}
.forums-header h1 {
    color: #ffd700;
    font-size: 2.5rem;
    text-align: center;
    margin-bottom: 0.5rem;
    letter-spacing: 2px;
}
.forums-list {
    background: #23243a;
    border-radius: 0 0 12px 12px;
    padding: 2rem 2rem 2.5rem 2rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    max-width: 1150px;
    margin: 0 auto 2rem auto;
}
.forum-table {
    width: 100%;
    color: #f5f6fa;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 12px;
    overflow: hidden;
}
.forum-table th, .forum-table td {
    padding: 1.2rem 1rem;
    text-align: center;
    vertical-align: middle;
}
.forum-table th {
    background: #181824;
    color: #ffd700;
    font-size: 1.15rem;
    font-weight: bold;
    border-bottom: 2px solid #8be9fd55;
    letter-spacing: 1px;
}
.forum-table tr {
    background: #282a36;
    transition: background 0.2s;
}
.forum-table tr:hover {
    background: #34355b;
}
.forum-link {
    color: #ffd700;
    font-size: 1.1rem;
    font-weight: bold;
    text-decoration: none;
    transition: color 0.2s;
}
.forum-link:hover {
    color: #ffb86c;
    text-decoration: underline;
}
.forum-desc {
    color: #b8b8ff;
    font-size: 1.08rem;
    font-weight: 500;
    text-align: center;
}
.forum-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
    justify-content: center;
}
.btn-primary {
    background: linear-gradient(90deg, #ffb347 0%, #ffd700 100%);
    color: #232526;
    border: none;
    padding: 0.7rem 1.5rem;
    border-radius: 6px;
    font-weight: bold;
    margin-bottom: 0;
    transition: background 0.2s;
    text-decoration: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 1.08em;
    box-shadow: 0 2px 8px #ffd70033;
}
.btn-primary:hover {
    background: linear-gradient(90deg, #ffd700 0%, #ffb347 100%);
    color: #232526;
}
.btn-danger {
    background: #ff5555;
    color: #fff;
    border: none;
    padding: 0.7rem 1.5rem;
    border-radius: 6px;
    font-weight: bold;
    transition: background 0.2s;
    text-decoration: none;
    cursor: pointer;
}
.btn-danger:hover {
    background: #ff2222;
    color: #fff;
}
</style>

<div class="forums-header">
    <h1>{{ crew.name }}</h1>
</div>
<div class="forums-list">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:18px;margin-bottom:18px;">
        <div style="display:flex;align-items:center;gap:16px;">
            <div class="crew-logo" style="width:64px;height:64px;border-radius:50%;background:#34355b;display:flex;align-items:center;justify-content:center;font-size:2.2em;border:3px solid #ffd700;object-fit:cover;box-shadow:0 2px 12px #ffd70033;">
                <i class="fas fa-users"></i>
            </div>
            <div>
                <div class="forum-link" style="font-size:1.5em;">{{ crew.name }}</div>
                <div class="forum-desc" style="color:#ffd700;">Crew ID: {{ crew.id }}</div>
            </div>
        </div>
        <div class="forum-actions" style="align-items:flex-end;">
            {% if current_user_role == 'leader' %}
                <form method="POST" action="{{ url_for('invite_to_crew') }}">
                    {{ invite_form.hidden_tag() }}
                    {{ invite_form.submit(class_="btn btn-primary") }}
                </form>
            {% elif current_user_role in ['right_hand', 'left_hand'] %}
                <form method="POST" action="{{ url_for('invite_to_crew') }}">
                    {{ invite_form.hidden_tag() }}
                    {{ invite_form.submit(class_="btn btn-primary") }}
                </form>
            {% endif %}
            {% if current_user.crew_id == crew.id %}
                <form method="POST" action="{{ url_for('leave_crew') }}">
                    {{ leave_form.hidden_tag() }}
                    {{ leave_form.submit(class_="btn btn-danger") }}
                </form>
            {% endif %}
        </div>
        {% if crew.territories %}
            <div class="crew-territories">
                <h4>Controlled Territories</h4>
                <ul>
                    {% for t in crew.territories %}
                    <li>{{ t.city }} (Payout: ${{ t.payout }})</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    </div>

    {% if crew.description %}
    <div class="forum-desc" style="background:#181824;border-radius:10px;padding:16px 18px;margin-bottom:24px;">
        {{ crew.description }}
    </div>
    {% endif %}

    <table class="forum-table" style="margin-bottom:32px;">
        <tr>
            <th style="width:20%;">Members</th>
            <th style="width:20%;">Founded</th>
            <th style="width:20%;">Leader</th>
        </tr>
        <tr>
            <td>{{ members|length }}</td>
            <td>{{ crew.created_at.strftime('%b %d, %Y') if crew.created_at else 'Unknown' }}</td>
            <td>
                {% for member in members %}
                    {% if member.role == 'leader' %}
                        {{ member.user.character.name if member.user and member.user.character else 'Unknown' }}
                    {% endif %}
                {% endfor %}
            </td>
        </tr>
    </table>

    <div class="forum-section-title" style="color:#ffd700;font-size:1.18em;font-weight:700;margin-bottom:16px;margin-top:24px;letter-spacing:0.5px;text-align:left;">
        Members
    </div>
    <table class="forum-table">
        <tr>
            <th style="width:40%;">Member</th>
            <th style="width:30%;">Role</th>
            <th style="width:30%;">Actions</th>
        </tr>
        {% for member, role_form in member_forms %}
        <tr>
            <td>
                {% set character = member.user.character if member.user and member.user.character else None %}
                {% if character and character.profile_image %}
                  <img src="{{ url_for('static', filename=character.profile_image) if not character.profile_image.startswith('http') else character.profile_image }}" class="crew-avatar" alt="avatar" style="width:32px;height:32px;border-radius:50%;margin-right:8px;">
                {% else %}
                  <span class="crew-avatar" style="width:32px;height:32px;border-radius:50%;margin-right:8px;"><i class="fas fa-user"></i></span>
                {% endif %}
                <strong>
                  {{ character.name if character else "Unknown user (ID " ~ member.user_id ~ ")" }}
                </strong>
            </td>
            <td>
                {% if member.role == 'leader' %}
                  <span class="badge-role badge-leader">Leader</span>
                {% elif member.role == 'right hand' %}
                  <span class="badge-role badge-right">Right-Hand</span>
                {% elif member.role == 'left hand' %}
                  <span class="badge-role badge-left">Left-Hand</span>
                {% else %}
                  <span class="badge-role badge-member">Member</span>
                {% endif %}
            </td>
            <td>
                {% if member.user and current_user.id != member.user.id and current_user_role == 'leader' %}
                <form method="POST" action="{{ url_for('update_crew_role', crew_member_id=member.id) }}" class="crew-role-form" style="display:inline;">
                    {{ role_form.hidden_tag() }}
                    {{ role_form.new_role(class_="form-control", style="border-radius:6px;border:none;padding:4px 10px;margin-left:4px;font-size:0.98em;background:#23243a;color:#8be9fd;") }}
                    {{ role_form.submit(class_="btn btn-primary", style="margin-left:6px;") }}
                </form>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endblock %}
